<div id="steps2">
    <div class="checkout-grid p-lg-5">
        <!-- ======== COL IZQUIRDA ======== -->
        <ng-container *ngIf="listCarts.length > 0; else showAddress">
            <div id="main-left">
                <!-- DELIVERY METHODS: Solo mostrar para productos f铆sicos (Printful merch) -->
                <div class="mb-5" *ngIf="requiresShipping()">
                    <h3 class="mb-3 text-uppercase" style="color: #222; font-size: 1.25rem; letter-spacing: 0.5px; border-bottom: 2px solid #222; padding-bottom: 0.5rem;">
                        <i class="icon anm anm-truck-l me-2"></i>Tipo de env铆o
                    </h3>
                    <div class="d-flex flex-row mb-3">
                        <div class="py-3 px-5 border border-dark me-3">
                            <div class="d-flex flex-column justify-content-center">
                                <span class="text-center">
                                    <svg width="24" height="24" aria-hidden="true" class="Icon_icon-content-1__kPDLF" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24.04 24.04">
                                        <g data-name="S">
                                            <path d="M21.8 11.2 21 9.6zM21 9.6l-.7-1.5z"></path>
                                            <path d="M21 20h-2.5v-6H5v6H3v1h18Zm-10 0v-4h2v4ZM4.3 9.8l.7-.5V13h13.5V8.9l1.2.9.6-.8L12 2.9 9 5.1V3H6v4.3L3.7 9Zm6.6-2.4A2.1 2.1 0 0 1 12 7a1.54 1.54 0 0 1 1.5 1.5A1.54 1.54 0 0 1 12 10a2.1 2.1 0 0 1-1.1-.4 1.5 1.5 0 0 1-.4-1.1 1.5 1.5 0 0 1 .4-1.1"></path>
                                        </g>
                                    </svg>
                                </span>
                                <span class="text-center"> Domicilio </span>
                                <span class="text-center">GRATIS</span>
                            </div>
                        </div>
                        <div class="p-5 bg-warning d-none">
                            <div class="d-flex flex-column justify-content-center">
                                <span class="text-center">
                                    <svg width="24" height="24" aria-hidden="true" class="Icon_icon-content-1__kPDLF" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 24 24">
                                        <path d="M17.603 5H21v15h-3v-9.337L15.521 15l-1.929-3 4.01-7zM3 5v15h3v-9.492L12.313 20 14 17 6 5z"></path>
                                    </svg>
                                </span>
                                <span>Tienda</span>
                                <span class="texts_uppercaseL__dKrzo">GRATIS</span>
                            </div>
                        </div>
                        <div class="p-3 border border-muted w-25 d-none">
                            <div class="d-flex flex-column justify-content-center">
                                <span class="text-center">
                                    <svg width="24" height="24" aria-hidden="true" class="Icon_icon-content-1__kPDLF" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 24 24">
                                        <path d="M12 2C9.355 2 6.875 3.542 5.682 5.929c-1.295 2.589-.724 5.925 1.511 8.909.072.105 4.391 6.585 4.391 6.585l.416.624.416-.624 4.377-6.567c2.25-3.002 2.82-6.338 1.525-8.927C17.125 3.542 14.645 2 12 2m3.999 12.25c-.016.02-.019.022-3.999 5.994-3.98-5.972-3.983-5.974-3.993-5.987-2.017-2.693-2.552-5.639-1.43-7.881C7.602 4.326 9.73 3 12 3s4.398 1.325 5.423 3.376c1.122 2.242.587 5.188-1.424 7.874M12 5C9.794 5 8 6.794 8 9s1.794 4 4 4 4-1.794 4-4-1.794-4-4-4m0 7c-1.654 0-3-1.346-3-3s1.346-3 3-3 3 1.346 3 3-1.346 3-3 3"></path>
                                    </svg>
                                </span>
                                <span class="text-center">Punto de recogida</span>
                                <span class="text-center">GRATIS</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END DELIVERY METHODS -->

                <!-- SHIPPING RATES -->
                <div class="align-items-center mb-lg-5 mb-3 d-none">
                    <h3 class="fw-bold text-uppercase mb-0">
                        Entrega:
                        <span class="fw-normal text-capitalize">
                            <ng-container *ngIf="entregaUnica">
                                {{ fechaEntregaLabel }}
                            </ng-container>
                            <ng-container *ngIf="!entregaUnica">
                                {{ fechaEntregaMin }} - {{ fechaEntregaMax }}
                            </ng-container>
                        </span>
                    </h3>
                </div>
                <!-- END SHIPPING RATES -->
                
                <!--  MENSAJE INFORMATIVO: Para m贸dulos digitales/servicios/integraciones -->
                <div *ngIf="!requiresShipping()" class="alert mb-4" 
                     [ngClass]="{
                       'alert-success': moduleType === 'digital',
                       'alert-info': moduleType === 'service' || moduleType === 'integration'
                     }"
                     style="border-radius: 12px; border-left: 4px solid;">
                    
                    <!-- DIGITAL -->
                    <div *ngIf="moduleType === 'digital'" class="d-flex align-items-start">
                        <i class="icon anm anm-download-l me-3" style="font-size: 2rem; color: #28a745;"></i>
                        <div>
                            <h5 class="mb-2" style="color: #155724; font-weight: 600;">
                                <i class="icon anm anm-check-circle-o me-2"></i>Entrega digital instant谩nea
                            </h5>
                            <p class="mb-0" style="color: #155724;">
                                No necesitas proporcionar direcci贸n de env铆o. Te enviaremos el enlace de descarga a tu email.
                            </p>
                        </div>
                    </div>
                    
                    <!-- SERVICE -->
                    <div *ngIf="moduleType === 'service'" class="d-flex align-items-start">
                        <i class="icon anm anm-calendar-l me-3" style="font-size: 2rem; color: #17a2b8;"></i>
                        <div>
                            <h5 class="mb-2" style="color: #0c5460; font-weight: 600;">
                                <i class="icon anm anm-check-circle-o me-2"></i>Servicio personalizado
                            </h5>
                            <p class="mb-0" style="color: #0c5460;">
                                No necesitas proporcionar direcci贸n de env铆o. Te enviaremos instrucciones para agendar a tu email.
                            </p>
                        </div>
                    </div>
                    
                    <!-- INTEGRATION -->
                    <div *ngIf="moduleType === 'integration'" class="d-flex align-items-start">
                        <i class="icon anm anm-cog me-3" style="font-size: 2rem; color: #17a2b8;"></i>
                        <div>
                            <h5 class="mb-2" style="color: #0c5460; font-weight: 600;">
                                <i class="icon anm anm-check-circle-o me-2"></i>Acceso a integraci贸n
                            </h5>
                            <p class="mb-0" style="color: #0c5460;">
                                No necesitas proporcionar direcci贸n de env铆o. Te enviaremos credenciales a tu email.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!--  FORMULARIO SIMPLIFICADO: Para m贸dulos digitales/servicios (solo email si es guest) -->
                <div *ngIf="!requiresShipping() && !CURRENT_USER_AUTHENTICATED" class="mb-lg-5 mb-3">
                    <div class="card border-0 shadow-sm" style="border-radius: 12px;">
                        <div class="card-body p-4">
                            <h3 class="mb-3 text-uppercase" style="color: #222; font-size: 1.25rem; letter-spacing: 0.5px; border-bottom: 2px solid #222; padding-bottom: 0.5rem;">
                                <i class="icon anm anm-envelope-l me-2"></i>Informaci贸n de contacto
                            </h3>
                            <p class="text-muted mb-4">
                                <small>Te enviaremos la informaci贸n a este email</small>
                            </p>
                            
                            <form #contactForm="ngForm" novalidate>
                                <!-- Email (obligatorio) -->
                                <div class="row justify-content-center mb-3">
                                    <div class="form-group col-12">
                                        <label for="contact-email" class="form-label fw-bold">
                                            Email <span class="required text-danger">*</span>
                                        </label>
                                        <div class="position-relative">
                                            <input 
                                                name="contact_email" 
                                                [(ngModel)]="guestEmail" 
                                                #contactEmail="ngModel" 
                                                id="contact-email" 
                                                type="email" 
                                                required 
                                                email
                                                placeholder="tu@email.com" 
                                                class="form-control py-3" 
                                                [ngClass]="{'is-invalid': contactEmail.invalid && (contactEmail.touched || contactForm.submitted)}" 
                                            />
                                            <button 
                                                *ngIf="guestEmail" 
                                                type="button" 
                                                (click)="clearField('guestEmail')" 
                                                class="position-absolute d-flex align-items-center justify-content-center" 
                                                style="right: 12px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border: none; background: rgba(108, 117, 125, 0.1); border-radius: 50%; cursor: pointer;">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div *ngIf="contactEmail.invalid && (contactEmail.touched || contactForm.submitted)" class="invalid-feedback d-block">
                                            <span *ngIf="contactEmail.errors?.required">El email es obligatorio</span>
                                            <span *ngIf="contactEmail.errors?.email">Ingresa un email v谩lido</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Nombre (opcional pero recomendado) -->
                                <div class="row justify-content-center mb-3">
                                    <div class="form-group col-12">
                                        <label for="contact-name" class="form-label fw-bold">
                                            Nombre completo <span class="text-muted">(opcional)</span>
                                        </label>
                                        <input 
                                            name="contact_name" 
                                            [(ngModel)]="guestName" 
                                            id="contact-name" 
                                            type="text" 
                                            placeholder="Tu nombre" 
                                            class="form-control py-3" 
                                        />
                                        <small class="text-muted">Nos ayuda a personalizar la comunicaci贸n</small>
                                    </div>
                                </div>
                                
                                <!-- Bot贸n para continuar -->
                                <div class="row justify-content-center mt-4">
                                    <div class="col-12">
                                        <button 
                                            type="button"
                                            class="btn btn-dark w-100 py-3 text-uppercase fw-normal" 
                                            (click)="confirmarDireccion()"
                                            [disabled]="contactForm.invalid">
                                            Continuar al pago
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!--  MENSAJE PARA USUARIOS AUTENTICADOS: Confirmaci贸n de email -->
                <div *ngIf="!requiresShipping() && CURRENT_USER_AUTHENTICATED" class="mb-lg-5 mb-3">
                    <div class="card border-0 shadow-sm" style="border-radius: 12px; background: #f8f9fa;">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-start">
                                <i class="icon anm anm-check-circle-o me-3" style="font-size: 2rem; color: #28a745;"></i>
                                <div>
                                    <h5 class="mb-2" style="font-weight: 600;">
                                        Email de entrega confirmado
                                    </h5>
                                    <p class="mb-0 text-muted">
                                        Enviaremos la informaci贸n a: <strong>{{ CURRENT_USER_AUTHENTICATED.email }}</strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot贸n para continuar -->
                    <div class="row justify-content-center mt-3">
                        <div class="col-12">
                            <button 
                                type="button"
                                class="btn btn-dark w-100 py-3 text-uppercase fw-normal" 
                                (click)="confirmarDireccion()">
                                Continuar al pago
                            </button>
                        </div>
                    </div>
                </div>

                <!--  SHIPPING ADDRESS: Solo mostrar si requiere env铆o (Printful o m贸dulos f铆sicos) -->
                <div *ngIf="requiresShipping()" class="mb-lg-5 mb-3" [ngClass]="{'w-100': isDesktop}">
                    <div class="dashboard-content h-100 mb-3" id="top-tabContent">
                        <!-- Address Book -->
                        <div class="tab-pane h-100" id="address">
                            <div class="address-card mt-0 h-100">
                                <!-- Register address (Primera vez o modo edici贸n/nuevo) -->
                                <ng-container *ngIf="listAddresses.length == 0 || showAddressForm; else allShowListAddress">
                                    <div class="mb-4" id="addressFormContainer">
                                        <div class="dashboard-content h-100" id="top-tabContent">
                                            <!-- Address Book -->
                                            <div class="tab-pane h-100" id="address">
                                                <div class="address-card mt-0 h-100">
                                                    <!-- Header con bot贸n de cancelar para modo edici贸n -->
                                                    <div class="address-book-section">
                                                        <div class="d-flex justify-content-between align-items-center mb-4" style="border-bottom: 2px solid #222; padding-bottom: 0.5rem;">
                                                            <h3 class="mb-0 text-uppercase" style="color: #222; font-size: 1.25rem; letter-spacing: 0.5px;">
                                                                <i class="icon anm anm-map-marker-al me-2"></i>
                                                                {{ isEditMode ? 'Editar direcci贸n' : 'Datos de env铆o' }}
                                                            </h3>
                                                            <!-- Bot贸n cancelar en modo edici贸n o cuando hay direcciones y se muestra formulario -->
                                                            <button 
                                                                *ngIf="isEditMode || (showAddressForm && listAddresses.length > 0)" 
                                                                type="button" 
                                                                class="btn btn-outline-secondary btn-sm"
                                                                (click)="cancelAddressForm()">
                                                                <i class="icon anm anm-times-l me-1"></i>Cancelar
                                                            </button>
                                                        </div>
                                                        <form #addressForm="ngForm" novalidate (ngSubmit)="storeAddress()">
                                                            <fieldset>
                                                                <!-- Nombre -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12">
                                                                        <label for="firstname" class="form-label d-none">Nombre <span class="required">*</span></label>
                                                                        <div class="position-relative">
                                                                            <input name="firstname" 
                                                                                   [(ngModel)]="name" 
                                                                                   #firstname="ngModel" 
                                                                                   id="firstname" 
                                                                                   type="text" 
                                                                                   required 
                                                                                   placeholder="Nombre" 
                                                                                   class="form-control py-4" 
                                                                                   [ngClass]="{'is-invalid': firstname.invalid && (firstname.touched || addressForm.submitted)}" />
                                                                            <button *ngIf="name" 
                                                                                    type="button" 
                                                                                    (click)="clearField('name')" 
                                                                                    class="position-absolute d-flex align-items-center justify-content-center" 
                                                                                    style="right: 12px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border: none; background: rgba(108, 117, 125, 0.1); border-radius: 50%; cursor: pointer; transition: all 0.2s ease; padding: 0;"
                                                                                    onmouseover="this.style.background='rgba(220, 53, 69, 0.1)'"
                                                                                    onmouseout="this.style.background='rgba(108, 117, 125, 0.1)'">
                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16" style="color: #6c757d;">
                                                                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <div *ngIf="firstname.invalid && (firstname.touched || addressForm.submitted)" class="invalid-feedback">
                                                                            Completa este campo para continuar
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!-- Apellidos -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12">
                                                                        <label for="lastname" class="form-label d-none">Apellidos <span class="required">*</span></label>
                                                                        <div class="position-relative">
                                                                            <input name="lastname" [(ngModel)]="surname" #lastname="ngModel" id="lastname" type="text" required placeholder="Apellidos" class="form-control py-4" [ngClass]="{'is-invalid': lastname.invalid && (lastname.touched || addressForm.submitted)}" />
                                                                            <button *ngIf="surname" 
                                                                                    type="button" 
                                                                                    (click)="clearField('surname')" 
                                                                                    class="position-absolute d-flex align-items-center justify-content-center" 
                                                                                    style="right: 12px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border: none; background: rgba(108, 117, 125, 0.1); border-radius: 50%; cursor: pointer; transition: all 0.2s ease; padding: 0;"
                                                                                    onmouseover="this.style.background='rgba(220, 53, 69, 0.1)'"
                                                                                    onmouseout="this.style.background='rgba(108, 117, 125, 0.1)'">
                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16" style="color: #6c757d;">
                                                                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <div *ngIf="lastname.invalid && (lastname.touched || addressForm.submitted)" class="invalid-feedback">
                                                                            Completa este campo para continuar
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!-- Email -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12">
                                                                        <label for="email" class="form-label d-none">E-Mail <span class="required">*</span></label>
                                                                        <div class="position-relative">
                                                                            <input name="email" [(ngModel)]="email" #emailRef="ngModel" id="email" type="email" required placeholder="E-mail" class="form-control py-4" [ngClass]="{'is-invalid': emailRef.invalid && (emailRef.touched || addressForm.submitted)}" />
                                                                            <button *ngIf="email" 
                                                                                    type="button" 
                                                                                    (click)="clearField('email')" 
                                                                                    class="position-absolute d-flex align-items-center justify-content-center" 
                                                                                    style="right: 12px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border: none; background: rgba(108, 117, 125, 0.1); border-radius: 50%; cursor: pointer; transition: all 0.2s ease; padding: 0;"
                                                                                    onmouseover="this.style.background='rgba(220, 53, 69, 0.1)'"
                                                                                    onmouseout="this.style.background='rgba(108, 117, 125, 0.1)'">
                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16" style="color: #6c757d;">
                                                                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <div *ngIf="emailRef.invalid && (emailRef.touched || addressForm.submitted)" class="invalid-feedback">
                                                                            Completa este campo para continuar
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!-- Pais -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12">
                                                                        <label for="address_country1" class="form-label d-none">Pa铆s <span class="required">*</span></label>
                                                                        <select 
                                                                        id="address_country1" 
                                                                        name="address[country]" 
                                                                        [(ngModel)]="pais" 
                                                                        #paisSelect="ngModel" 
                                                                        required 
                                                                        class="form-control py-4 fw-light" 
                                                                        [ngClass]="{'is-invalid': paisSelect.invalid && (paisSelect.touched || addressForm.submitted)}">
                                                                            <option value="" disabled>Pa铆s</option>
                                                                            <optgroup label=" Uni贸n Europea">
                                                                                <option *ngFor="let country of supportedCountries" 
                                                                                        [value]="country.code" 
                                                                                        [label]="country.name">
                                                                                    {{ country.name }}
                                                                                </option>
                                                                            </optgroup>
                                                                        </select>
                                                                        <div *ngIf="paisSelect.invalid && (paisSelect.touched || addressForm.submitted)" class="invalid-feedback">
                                                                            Completa este campo para continuar
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!-- Calle -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12">
                                                                        <label for="calle" class="form-label d-none">Calle <span class="required">*</span></label>
                                                                        <div class="position-relative">
                                                                            <input name="calle" id="calle" type="text" required [(ngModel)]="calle" #calleRef="ngModel" placeholder="Calle (ej: Calle Gran V铆a)" class="form-control py-4 fw-light" [ngClass]="{'is-invalid': calleRef.invalid && (calleRef.touched || addressForm.submitted)}" />
                                                                            <button *ngIf="calle" 
                                                                                    type="button" 
                                                                                    (click)="clearField('calle')" 
                                                                                    class="position-absolute d-flex align-items-center justify-content-center" 
                                                                                    style="right: 12px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border: none; background: rgba(108, 117, 125, 0.1); border-radius: 50%; cursor: pointer; transition: all 0.2s ease; padding: 0;"
                                                                                    onmouseover="this.style.background='rgba(220, 53, 69, 0.1)'"
                                                                                    onmouseout="this.style.background='rgba(108, 117, 125, 0.1)'">
                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16" style="color: #6c757d;">
                                                                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <div *ngIf="calleRef.invalid && (calleRef.touched || addressForm.submitted)" class="invalid-feedback">
                                                                            Completa este campo para continuar
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <!-- N煤mero -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12">
                                                                        <label for="numero" class="form-label d-none">N煤mero <span class="required">*</span></label>
                                                                        <div class="position-relative">
                                                                            <input name="numero" id="numero" type="text" required [(ngModel)]="numero" #numeroRef="ngModel" placeholder="N煤mero (ej: 123)" class="form-control py-4 fw-light" [ngClass]="{'is-invalid': numeroRef.invalid && (numeroRef.touched || addressForm.submitted)}" />
                                                                            <button *ngIf="numero" 
                                                                                    type="button" 
                                                                                    (click)="clearField('numero')" 
                                                                                    class="position-absolute d-flex align-items-center justify-content-center" 
                                                                                    style="right: 12px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border: none; background: rgba(108, 117, 125, 0.1); border-radius: 50%; cursor: pointer; transition: all 0.2s ease; padding: 0;"
                                                                                    onmouseover="this.style.background='rgba(220, 53, 69, 0.1)'"
                                                                                    onmouseout="this.style.background='rgba(108, 117, 125, 0.1)'">
                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16" style="color: #6c757d;">
                                                                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <div *ngIf="numeroRef.invalid && (numeroRef.touched || addressForm.submitted)" class="invalid-feedback">
                                                                            Debes incluir el n煤mero de la calle para el env铆o
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <!-- Apartamento/Piso (Opcional) -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12">
                                                                        <label for="apartamento" class="form-label d-none">Apartamento/Piso</label>
                                                                        <div class="position-relative">
                                                                            <input name="apartamento" id="apartamento" type="text" [(ngModel)]="apartamento" placeholder="Apartamento/Piso (opcional, ej: 3潞 B)" class="form-control py-4 fw-light" />
                                                                            <button *ngIf="apartamento" 
                                                                                    type="button" 
                                                                                    (click)="clearField('apartamento')" 
                                                                                    class="position-absolute d-flex align-items-center justify-content-center" 
                                                                                    style="right: 12px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border: none; background: rgba(108, 117, 125, 0.1); border-radius: 50%; cursor: pointer; transition: all 0.2s ease; padding: 0;"
                                                                                    onmouseover="this.style.background='rgba(220, 53, 69, 0.1)'"
                                                                                    onmouseout="this.style.background='rgba(108, 117, 125, 0.1)'">
                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16" style="color: #6c757d;">
                                                                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <small class="form-text text-muted">Opcional: piso, puerta, escalera, etc.</small>
                                                                    </div>
                                                                </div>

                                                                <!--  C贸digo postal (MANGO.ES STYLE) -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12">
                                                                        <label for="postcode" class="form-label d-none">C贸digo postal <span class="required">*</span></label>
                                                                        <div class="position-relative">
                                                                            <input name="postcode" 
                                                                                   id="postcode" 
                                                                                   type="text" 
                                                                                   required 
                                                                                   [(ngModel)]="zipcode" 
                                                                                   #zipcodeRef="ngModel"
                                                                                   (blur)="onZipCodeChange(zipcode)"
                                                                                   (change)="onZipCodeChange(zipcode)"
                                                                                   placeholder="C贸digo postal (ej: 28013)" 
                                                                                   class="form-control py-4 fw-light" 
                                                                                   [ngClass]="{
                                                                                       'is-invalid': (zipcodeRef.invalid && (zipcodeRef.touched || addressForm.submitted)) || postalCodeError
                                                                                   }" />
                                                                            <button *ngIf="zipcode && !isLoadingPostalCode" 
                                                                                    type="button" 
                                                                                    (click)="clearField('zipcode')" 
                                                                                    class="position-absolute d-flex align-items-center justify-content-center" 
                                                                                    style="right: 12px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border: none; background: rgba(108, 117, 125, 0.1); border-radius: 50%; cursor: pointer; transition: all 0.2s ease; padding: 0; z-index: 10;"
                                                                                    onmouseover="this.style.background='rgba(220, 53, 69, 0.1)'"
                                                                                    onmouseout="this.style.background='rgba(108, 117, 125, 0.1)'">
                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16" style="color: #6c757d;">
                                                                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                                                                </svg>
                                                                            </button>
                                                                            <!-- Spinner de carga -->
                                                                            <div *ngIf="isLoadingPostalCode" 
                                                                                 class="position-absolute" 
                                                                                 style="right: 10px; top: 50%; transform: translateY(-50%);">
                                                                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                                                    <span class="visually-hidden">Buscando...</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!-- Error de validaci贸n est谩ndar -->
                                                                        <div *ngIf="zipcodeRef.invalid && (zipcodeRef.touched || addressForm.submitted) && !postalCodeError" class="invalid-feedback d-block">
                                                                            Completa este campo para continuar
                                                                        </div>
                                                                        <!-- Error de c贸digo postal no encontrado -->
                                                                        <div *ngIf="postalCodeError" class="invalid-feedback d-block">
                                                                            <i class="icon anm anm-times-r me-1"></i>{{ postalCodeError }}
                                                                        </div>
                                                                        <!-- Mensaje de 茅xito -->
                                                                        <div *ngIf="zipcode && !postalCodeError && !isLoadingPostalCode && ciudad" class="text-success small mt-1">
                                                                            <i class="icon anm anm-check me-1"></i>C贸digo postal v谩lido
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!--  Ciudad/Poblaci贸n (DROPDOWN SI HAY MLTIPLES OPCIONES) -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12">
                                                                        <label for="new-city" class="form-label d-none">Ciudad <span class="required">*</span></label>
                                                                        
                                                                        <!-- Dropdown si hay m煤ltiples ciudades -->
                                                                        <ng-container *ngIf="availableCities.length > 1; else singleCity">
                                                                            <select name="city" 
                                                                                    id="new-city-select"
                                                                                    required 
                                                                                    [(ngModel)]="poblacion" 
                                                                                    #poblacionSelect="ngModel" 
                                                                                    class="form-control py-4 fw-light"
                                                                                    [ngClass]="{'is-invalid': poblacionSelect.invalid && (poblacionSelect.touched || addressForm.submitted)}">
                                                                                <option value="" disabled>Selecciona tu ciudad</option>
                                                                                <option *ngFor="let cityObj of availableCities" 
                                                                                        [value]="cityObj.city">
                                                                                    {{ cityObj.city }}
                                                                                    <span *ngIf="cityObj.isPrimary"> (Principal)</span>
                                                                                </option>
                                                                            </select>
                                                                            
                                                                            <small class="form-text text-success mt-1">
                                                                                <i class="icon anm anm-check me-1"></i>{{ availableCities.length }} ciudades disponibles para este c贸digo postal
                                                                            </small>
                                                                            
                                                                            <div *ngIf="poblacionSelect.invalid && (poblacionSelect.touched || addressForm.submitted)" class="invalid-feedback d-block">
                                                                                Por favor selecciona una ciudad
                                                                            </div>
                                                                        </ng-container>
                                                                        
                                                                        <!-- Input si hay una sola ciudad o a煤n no se ha buscado -->
                                                                        <ng-template #singleCity>
                                                                            <input name="city" 
                                                                                   placeholder="Ciudad (se autocompleta con el CP)" 
                                                                                   class="form-control py-4 fw-light bg-light" 
                                                                                   required 
                                                                                   [(ngModel)]="poblacion" 
                                                                                   #poblacionInput="ngModel" 
                                                                                   [readonly]="availableCities.length === 1"
                                                                                   [ngClass]="{'is-invalid': poblacionInput.invalid && (poblacionInput.touched || addressForm.submitted)}" 
                                                                                   id="new-city" 
                                                                                   type="text" />
                                                                            
                                                                            <small class="form-text text-muted" *ngIf="availableCities.length === 0 && !poblacion">
                                                                                <i class="icon anm anm-info-r me-1"></i>Se autocompletar谩 al ingresar el c贸digo postal
                                                                            </small>
                                                                            
                                                                            <div *ngIf="poblacionInput.invalid && (poblacionInput.touched || addressForm.submitted)" class="invalid-feedback d-block">
                                                                                Ingresa primero el c贸digo postal
                                                                            </div>
                                                                        </ng-template>
                                                                        
                                                                        <!-- Error de validaci贸n de ciudad -->
                                                                        <div *ngIf="cityError" class="invalid-feedback d-block">
                                                                            <i class="icon anm anm-times-r me-1"></i>{{ cityError }}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!--  Provincia/Estado (AUTOCOMPLETADA - READONLY) -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12">
                                                                        <label for="address_State" class="form-label d-none">Provincia/Estado <span class="required">*</span></label>
                                                                        <input name="state" 
                                                                               placeholder="Provincia (se autocompleta con el CP)" 
                                                                               class="form-control py-4 fw-light bg-light" 
                                                                               required 
                                                                               [(ngModel)]="ciudad" 
                                                                               #ciudadRef="ngModel" 
                                                                               [readonly]="isProvinceReadonly"
                                                                               [ngClass]="{'is-invalid': ciudadRef.invalid && (ciudadRef.touched || addressForm.submitted)}" 
                                                                               id="address_State" 
                                                                               type="text" />
                                                                        <small class="form-text text-muted" *ngIf="!ciudad">
                                                                            <i class="icon anm anm-info-r me-1"></i>Se autocompletar谩 al ingresar el c贸digo postal
                                                                        </small>
                                                                        <div *ngIf="ciudadRef.invalid && (ciudadRef.touched || addressForm.submitted)" class="invalid-feedback">
                                                                            Ingresa primero el c贸digo postal
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!-- Telefono -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12">
                                                                        <label for="phone" class="form-label d-none">M贸vil <span class="required">*</span></label>
                                                                        <div class="position-relative">
                                                                            <input name="phone" id="phone" type="tel" required [(ngModel)]="phone" #phoneRef="ngModel" placeholder="M贸vil" class="form-control py-4 fw-light" [ngClass]="{'is-invalid': phoneRef.invalid && (phoneRef.touched || addressForm.submitted)}" />
                                                                            <button *ngIf="phone" 
                                                                                    type="button" 
                                                                                    (click)="clearField('phone')" 
                                                                                    class="position-absolute d-flex align-items-center justify-content-center" 
                                                                                    style="right: 12px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border: none; background: rgba(108, 117, 125, 0.1); border-radius: 50%; cursor: pointer; transition: all 0.2s ease; padding: 0;"
                                                                                    onmouseover="this.style.background='rgba(220, 53, 69, 0.1)'"
                                                                                    onmouseout="this.style.background='rgba(108, 117, 125, 0.1)'">
                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16" style="color: #6c757d;">
                                                                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <div *ngIf="phoneRef.invalid && (phoneRef.touched || addressForm.submitted)" class="invalid-feedback">
                                                                            Completa este campo para continuar
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!-- CheckBook-->
                                                                <div class="row justify-content-center pt-2 pb-4">
                                                                    <div class="form-group col-12 col-sm-6 col-md-6 col-lg-12">
                                                                        <div class="checkout-tearm customCheckbox">
                                                                            <input id="checkout_usual_shipping_address" name="checkout_usual_shipping_address" [(ngModel)]="usual_shipping_address" type="checkbox" value="checkout tearm" required />
                                                                            <label for="checkout_usual_shipping_address">
                                                                                Elegir como direcci贸n de env铆o habitual</label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!-- Button register o update -->
                                                                <div class="row justify-content-center">
                                                                    <div class="form-group col-12 col-sm-6 col-md-6 col-lg-12">
                                                                        <button type="submit" 
                                                                                class="btn btn-dark w-100 py-3 text-uppercase fw-semibold d-flex align-items-center justify-content-center" 
                                                                                (click)="storeAddress()" 
                                                                                [disabled]="isValidating"
                                                                                style="letter-spacing: 1px; border-radius: 8px; transition: all 0.3s ease; font-size: 1rem;">
                                                                            <ng-container *ngIf="!isValidating">
                                                                                <i class="icon anm anm-check-cil me-2" style="font-size: 1.2rem;"></i>
                                                                                <span>{{ isEditMode ? 'Actualizar direcci贸n' : 'Guardar direcci贸n' }}</span>
                                                                            </ng-container>
                                                                            <ng-container *ngIf="isValidating">
                                                                                <div class="spinner-border spinner-border-sm text-white me-2" role="status">
                                                                                    <span class="visually-hidden">Validando...</span>
                                                                                </div>
                                                                                <span>Validando...</span>
                                                                            </ng-container>
                                                                        </button>
                                                                        
                                                                        <!-- Mensaje de validaci贸n en progreso -->
                                                                        <div *ngIf="validationMessage" class="alert alert-info mt-3 mb-0 py-2 px-3" style="border-left: 4px solid #0dcaf0; border-radius: 6px;">
                                                                            <i class="icon anm anm-info-cil me-2"></i>
                                                                            {{ validationMessage }}
                                                                        </div>
                                                                        
                                                                        <!-- Mensaje de error -->
                                                                        <div class="alert alert-danger mt-3 mb-0 py-2 px-3" *ngIf="validMessage && !status" style="border-left: 4px solid #dc3545; border-radius: 6px;">
                                                                            <i class="icon anm anm-times-circle me-2"></i>
                                                                            <strong>Error:</strong> {{ errorOrSuccessMessage }}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </fieldset>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- End Address Book -->
                                        </div>
                                    </div>
                                </ng-container>

                                <!-- Address List -->
                                <ng-template #allShowListAddress>
                                    <!-- Spinner -->
                                    <div *ngIf="loading" class="loading-spinner d-flex justify-content-center h-100 align-items-center" style="min-height: 300px;">
                                        <div class="text-center">
                                            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            <p class="text-muted fw-semibold" style="font-size: 1rem; letter-spacing: 0.5px;">Cargando direcciones...</p>
                                        </div>
                                    </div>

                                    <!-- Mostrar la lista de direcciones & ShippingRates -->
                                    <div class="address-book-section" [class.d-none]="loading">
                                        <div class="top-sec d-flex mb-3 d-flex justify-content-between align-items-center" [class.d-none]="loading">
                                            <h3 class="mb-0 text-uppercase">Datos de env铆o</h3>
                                            <div class="d-flex gap-2">
                                                <button type="button" class="btn btn-outline-primary btn-sm" (click)="showNewAddressForm()">
                                                    <i class="icon anm anm-plus-l me-1"></i>Nueva direcci贸n
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="openAddressModal()">
                                                    <i class="icon anm anm-edit-l me-1"></i>Cambiar
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <ng-container *ngIf="selectedAddress">
                                                <div class="address-select-box active">
                                                    <div class="address-box bg-block">
                                                        <div class="d-flex flex-row justify-content-between mb-3">
                                                            <div class="d-flex flex-row">
                                                                <span class="d-flex flex-row">
                                                                    <svg width="24" height="24" aria-hidden="true" class="Icon_icon-content-1__kPDLF" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 24 24">
                                                                        <path d="M19 20V9.3l.7.5.6-.8L12 2.9 9 5.1V3H6v4.3L3.7 9l.6.8.7-.5V20H3v1h18v-1zM7 4h1v1.8l-1 .8zM6 8.6l6-4.4 6 4.4V12H6zM11 20v-4h2v4zm-1-5v5H6v-7h12v7h-4v-5z"></path>
                                                                        <path d="M12 7c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m0 3c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1-.4 1-1 1"></path>
                                                                    </svg>
                                                                </span>
                                                                <span class="px-2 fw-bold">Domicilio</span>
                                                                <span class="fw-bold">GRATIS</span>
                                                            </div>
                                                        </div>
                                                        <!-- Shipping rates -->
                                                        <div class="mb-3">
                                                            <p class="fw-bold text-uppercase mb-0">
                                                                Entrega:
                                                                <span class="fw-normal text-capitalize">
                                                                    <ng-container *ngIf="entregaUnica">
                                                                        {{ fechaEntregaLabel }}
                                                                    </ng-container>
                                                                    <ng-container *ngIf="!entregaUnica">
                                                                        {{ fechaEntregaMin }} - {{ fechaEntregaMax }}
                                                                    </ng-container>
                                                                </span>
                                                            </p>
                                                        </div>
                                                        <!-- End Shipping rates -->
                                                        <div class="top d-flex-justify-center justify-content-between">
                                                            <p class="m-0 fw-light">{{selectedAddress.name + " " + selectedAddress.surname}}</p>
                                                        </div>
                                                        <div class="middle lh-1">
                                                            <div class="address mb-1">
                                                                <p class="fw-light">
                                                                    {{ selectedAddress.email }}
                                                                </p>
                                                            </div>
                                                            <div class="address mb-1">
                                                                <p class="fw-light">
                                                                    Tel. +34 {{ selectedAddress.phone }}
                                                                </p>
                                                            </div>
                                                            <div class="address mb-1">
                                                                <p class="fw-light">
                                                                    {{
                                                   selectedAddress.address +
                                                   ", " +
                                                   selectedAddress.zipcode +
                                                   ", " +
                                                   selectedAddress.ciudad +
                                                   ", " +
                                                   selectedAddress.poblacion
                                                   }}
                                                                </p>
                                                            </div>
                                                            <div class="address mb-1 d-none">
                                                                <p class="fw-light">
                                                                    {{ selectedAddress.zipcode }}
                                                                    {{ selectedAddress.poblacion }},
                                                                    <span class="text-uppercase">{{
                                                   selectedAddress.ciudad
                                                   }}</span><br />
                                                                </p>
                                                            </div>
                                                            <div class="badge px-3 py-2 mt-3 d-inline-flex align-items-center" 
                                                                 style="
                                                                     width: fit-content !important;
                                                                     background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                                                                     color: white;
                                                                     font-weight: 600;
                                                                     font-size: 0.65rem;
                                                                     letter-spacing: 0.5px;
                                                                     border: 1px solid rgba(40, 167, 69, 0.2);
                                                                     box-shadow: 0 2px 8px rgba(40, 167, 69, 0.15);
                                                                 " 
                                                                 *ngIf="selectedAddress.usual_shipping_address">
                                                                <i class="icon anm anm-check-cil me-2" style="font-size: 0.9rem;"></i>
                                                                <span class="text-uppercase">Direcci贸n habitual</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </div>
                                    </div>
                                </ng-template>
                            </div>
                        </div>
                        <!-- End Address Book -->
                    </div>
                </div>
                <!-- END SHIPPING ADDRESS -->

                <!-- CART SUMMARY VERSION MVIL -->
                <div class="cart-info mb-4 d-block d-md-none bg-white border-0 p-0">
                    <div class="cart-info mb-4 bg-white border-0 p-0">
                        <h3 class="title mb-3 text-uppercase ">Resumen de Precio</h3>
                        <div class="cart-order-detail cart-col">
                            <!-- Subtotal-->
                            <div class="row g-0">
                                <span class="col-6 col-sm-6 cart-subtotal-title fw-light">Subtotal</span>
                                <span class="col-6 col-sm-6 cart-subtotal-title cart-subtotal text-end">
                                    <span class="money">
                                        <!-- Mostrar subtotal original solo si hay descuentos, sino mostrar subtotal final -->
                                        <ng-container *ngIf="hasAnyCartDiscount(); else noDiscountSubtotal">
                                            <span class="price-small fw-light old-price text-decoration-line-through">
                                                <span class="me-1">{{ euro }}</span>
                                                <span>{{getFormattedPrice(getOriginalSubtotal()).integerPart}}.{{getFormattedPrice(getOriginalSubtotal()).decimalPart}}</span>
                                            </span>
                                        </ng-container>
                                        <ng-template #noDiscountSubtotal>
                                            <span class="price-small fw-light">
                                                <span class="me-1">{{ euro }}</span>
                                                <span>{{getFormattedPrice(getSubtotal()).integerPart}}.{{getFormattedPrice(getSubtotal()).decimalPart}}</span>
                                            </span>
                                        </ng-template>
                                    </span>
                                </span>
                            </div>

                            <!-- Descuento aplicado (solo si hay descuentos) -->
                            <div class="row g-0" *ngIf="hasAnyCartDiscount()">
                                <span class="col-6 col-sm-6 cart-subtotal-title text-danger fw-light">Descuento</span>
                                <span class="col-6 col-sm-6 cart-subtotal-title cart-subtotal text-end text-danger">
                                    <span class="money">
                                        <span class="price-small fw-light">
                                            <span class="me-1">{{ euro }}</span>
                                            -<span>{{getFormattedPrice(getTotalDiscount()).integerPart}}.{{getFormattedPrice(getTotalDiscount()).decimalPart}}</span>
                                        </span>
                                    </span>
                                </span>
                            </div>

                            <!-- Env铆o Gratis -->
                            <div class="row g-0 mb-2">
                                <span class="col-6 col-sm-6 cart-subtotal-title fw-light">Env铆o</span>
                                <span class="col-6 col-sm-6 cart-subtotal-title cart-subtotal text-end"><span class="money fw-light">Gratis</span></span>
                            </div>

                            <!-- Total Precio actual -->
                            <div class="row g-0">
                                <span class="col-6 col-sm-6 cart-subtotal-title fs-6 text-uppercase fw-normal">Total</span>
                                <span class="col-6 col-sm-6 cart-subtotal-title fs-6 cart-subtotal text-end">
                                    <span class="money price fw-normal">
                                        <span class="me-1">{{ euro }}</span>
                                        <span>{{getFormattedPrice(getTotal()).integerPart}}.{{ getFormattedPrice(getTotal()).decimalPart }}</span>
                                        
                                    </span>
                                </span>
                            </div>

                            <!-- Impuestos incluidos -->
                            <div class="row g-0 d-none">
                                <div class="col-6 col-sm-6text-center">
                                    <small class="text-muted fw-light">Impuestos incluidos</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END CART SUMMARY VERSION MVIL -->

                <!-- BOTON CONTINUAR A PAGO -->
                <ng-container *ngIf="listAddresses.length != 0 && !showAddressForm">
                    <div class="d-flex flex-column mb-4">
                        <button type="button" 
                                class="btn btn-dark w-100 py-3 text-uppercase fw-semibold d-flex align-items-center justify-content-center mb-3" 
                                (click)="goToNextStep()"
                                style="letter-spacing: 1px; border-radius: 8px; transition: all 0.3s ease; font-size: 1rem;">
                            <i class="icon anm anm-arrow-right me-2" style="font-size: 1.2rem;"></i>
                            <span>Continuar a pago</span>
                        </button>
                        <p class="text-center mb-0" style="font-size: 0.85rem;">
                            <small class="text-muted">Al continuar, confirmas que has le铆do la
                                <a class="text-dark fw-semibold text-decoration-underline"
                                   target="_blank"
                                    style="cursor: pointer;"
                                   (click)="openInNewTab('privacy-policy')">Pol铆tica de privacidad</a>
                                </small>
                        </p>
                    </div>
                </ng-container>
                <!-- END BOTON CONTINUAR A PAGO -->
            </div>
        </ng-container>
        <ng-template #showAddress>
            <div id="main-left" class="text-center py-5">
                <i class="icon anm anm-bag-l d-block mb-4" style="font-size: 5rem; color: #dee2e6;"></i>
                <h3 class="text-uppercase mb-3" style="color: #222; font-size: 1.5rem; letter-spacing: 0.5px;">
                    Tu carrito est谩 vac铆o
                </h3>
                <p class="text-muted mb-4" style="font-size: 1rem; max-width: 500px; margin: 0 auto;">
                    Insp铆rate con las 煤ltimas tendencias y descubre algo nuevo para renovar tu armario
                </p>
                <div class="mt-4">
                    <a onclick="return false;" [routerLink]="['/', country, locale, 'shop', 'filter-products']" class="text-decoration-none">
                        <button class="btn-dark-ld text-uppercase">Descubrir novedades</button>
                    </a>
                </div>
            </div>
        </ng-template>
        <!-- ======== END COL IZQUIRDA ======== -->

        <!--  -->
        <!--  -->

        <!-- ======== COL DERECHA ======== -->
        <div id="main-right">
            <!-- BLOQUE: TU CARRITO -->
            <div class="order-1">
                <h3 class="title mb-0 text-uppercase mb-3">Tu carrito</h3>

                <!-- AHORA EL CUPON SE GESTIONA EN LIST CART -->
                <!-- CODIGO PROMOCIONAL OCUTALMOS-->
                <!-- 
                <div class="mb-3 codigo_promocional mb-3 d-none">
                    <div class="block-content">
                        <div class="payment-accordion-radio">
                            <div class="accordion" id="accordionExample">
                                <div class="accordion-item card mb-2 px-3 border border-muted">
                                    <div class="card-header p-3" id="headingTwo">
                                        <button class="card-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                            <span class="customRadio clearfix mb-0">
                                                <input id="paymentRadio2" value="" name="payment" type="radio" class="radio" />
                                                <label for="paymentRadio2" class="mb-0 fw-light">C贸digo promocional</label>
                                            </span>
                                        </button>
                                    </div>
                                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                                        <div class="card-body px-0">
                                            <p class="fw-light">
                                                Introduce tu c贸digo promocional y disfruta de grandes
                                                ahorros en tu compra.
                                            </p>
                                            <div class="input-group mb-0 d-flex">
                                                <input id="coupon-code" [(ngModel)]="code_cupon" required="" type="text" class="form-control border border-muted mb-3 fs-14" placeholder="C贸digo de promoci贸n" />
                                                <button class="coupon-btn border-muted btn-dark-ld" (click)="apllyCupon()" [disabled]="loading" type="submit">
                                                    <div *ngIf="loading" class="loading-spinner justify-content-center align-items-center">
                                                        <div class="row">
                                                            <div class="col-sm-2">
                                                                <div class="sp bg-white sp-bars"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <span *ngIf="!loading">Aplicar</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->
                <!-- END CODIGO PROMOCIONAL -->

                <!-- CODIGO PROMOCIONAL OLD OCUTALMOS-->
                <!-- <div class="block mb-3 apply-code mb-4 p-0 d-none">
                    <div class="block-content">
                        <h3 class="title mb-3 text-uppercase">
                            Aplicar c贸digo promocional
                        </h3>
                        <div id="coupon" class="coupon-dec">
                            <p class="fw-light">
                                Introduce tu c贸digo promocional y disfruta de grandes ahorros
                                en tu compra.
                            </p>
                            <div class="input-group mb-0 d-flex">
                                <input id="coupon-code" [(ngModel)]="code_cupon" required="" type="text" class="form-control" placeholder="C贸digo de promoci贸n" />
                                <button class="coupon-btn btn btn-secondary fw-normal text-uppercase" (click)="apllyCupon()" [disabled]="loading" type="submit">
                                    <div *ngIf="loading" class="loading-spinner justify-content-center align-items-center">
                                        <div class="row">
                                            <div class="col-sm-2">
                                                <div class="sp bg-white sp-bars"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <span *ngIf="!loading">Aplicar</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div> -->
                <!-- END CODIGO PROMOCIONAL -->

                <!-- CART SUMMARY VERSION DESKTOP -->
                <div class="cart-info mb-5 mb-5 d-none d-md-block bg-white border-0 p-0">
                    <div class="cart-order-detail cart-col">
                        <!-- Subtotal-->
                        <div class="row g-0">
                            <span class="col-6 col-sm-6 cart-subtotal-title fw-light">Subtotal</span>
                            <span class="col-6 col-sm-6 cart-subtotal-title cart-subtotal text-end">
                                <span class="money">
                                    <!-- Mostrar subtotal original solo si hay descuentos, sino mostrar subtotal final -->
                                    <ng-container *ngIf="hasAnyCartDiscount(); else noDiscountSubtotal">
                                        <span class="price-small fw-light old-price text-decoration-line-through">
                                            <span class="me-1">{{ euro }}</span>
                                            <span>{{getFormattedPrice(getOriginalSubtotal()).integerPart}}.{{getFormattedPrice(getOriginalSubtotal()).decimalPart}}</span>
                                        </span>
                                    </ng-container>
                                    <ng-template #noDiscountSubtotal>
                                        <span class="price-small fw-light">
                                            <span class="me-1">{{ euro }}</span>
                                            <span>{{getFormattedPrice(getSubtotal()).integerPart}}.{{getFormattedPrice(getSubtotal()).decimalPart}}</span>
                                        </span>
                                    </ng-template>
                                </span>
                            </span>
                        </div>

                        <!-- Descuento aplicado (solo si hay descuentos) -->
                        <div class="row g-0" *ngIf="hasAnyCartDiscount()">
                            <span class="col-6 col-sm-6 cart-subtotal-title text-danger fw-light">Descuento</span>
                            <span class="col-6 col-sm-6 cart-subtotal-title cart-subtotal text-end text-danger">
                                <span class="money">
                                    <span class="price-small fw-light">
                                        <span class="me-1">{{ euro }}</span>
                                        -<span>{{getFormattedPrice(getTotalDiscount()).integerPart}}.{{getFormattedPrice(getTotalDiscount()).decimalPart}}</span>
                                    </span>
                                </span>
                            </span>
                        </div>

                        <!-- Env铆o Gratis -->
                        <div class="row g-0 mb-2">
                            <span class="col-6 col-sm-6 cart-subtotal-title fw-light">Env铆o</span>
                            <span class="col-6 col-sm-6 cart-subtotal-title cart-subtotal text-end"><span class="money fw-light">Gratis</span></span>
                        </div>

                        <!-- Total Precio actual -->
                        <div class="row g-0">
                            <span class="col-6 col-sm-6 cart-subtotal-title fs-6 text-uppercase fw-normal">Total</span>
                            <span class="col-6 col-sm-6 cart-subtotal-title fs-6 cart-subtotal text-end">
                                <span class="money price fw-normal">
                                    <span class="me-1">{{ euro }}</span>
                                    <span>{{getFormattedPrice(getTotal()).integerPart}}.{{ getFormattedPrice(getTotal()).decimalPart }}</span>
                                    
                                </span>
                            </span>
                        </div>

                        <!-- Impuestos incluidos -->
                        <div class="row g-0 d-none">
                            <div class="col-6 col-sm-6text-center">
                                <small class="text-muted fw-light">Impuestos incluidos</small>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- CART SUMMARY -->

                <!-- CARTS LIST  -->
                <div class="col-12 order-0 lists-carts  order-md-2">
                    <div class="block order-summary p-0">
                        <div class="block-content">
                            <h3 class="mb-0 text-uppercase">Art铆culos ({{ listCarts.length }})</h3>
                            <div class="order-list">
                                <ng-container *ngFor="let cart of listCarts">
                                    <div class="d-flex py-3 gap-3 align-items-start">
                                        <!-- Imagen -->
                                        <div style="flex: 0 0 auto">
                                            <a *ngIf="cart.product?.slug" [routerLink]="['/landing-product',cart.product.slug]">
                                                <img 
                                                    class="blur-up lazyload" 
                                                    [attr.data-src]="getVarietyImage(cart)" 
                                                    [src]="getVarietyImage(cart)" 
                                                    [alt]="cart.product?.title || 'Producto'" 
                                                    [title]="cart.product?.title || 'Producto'" 
                                                    width="120" 
                                                    height="170" 
                                                    />
                                            </a>
                                            <!-- Imagen sin link para m贸dulos (no tienen slug) -->
                                            <img *ngIf="!cart.product?.slug" 
                                                class="blur-up lazyload" 
                                                [attr.data-src]="getVarietyImage(cart)" 
                                                [src]="getVarietyImage(cart)" 
                                                [alt]="cart.product?.title || 'M贸dulo'" 
                                                [title]="cart.product?.title || 'M贸dulo'" 
                                                width="120" 
                                                height="170" 
                                                />

                                            <!-- <img class="blur-up lazyload" [attr.data-src]="cart.product.imagen" [src]="cart.product.imagen" alt="product" title="Product" width="120" height="170" /> -->
                                        </div>
                                        <!-- Info del producto -->
                                        <div class="flex-grow-1 d-flex flex-column justify-content-between">
                                            <!-- Datos adicionales -->
                                            <div class="d-flex flex-column ">
                                                <div class="d-flex lh-1 mb-2">
                                                    <div class="fw-normal me-2">
                                                        <!-- Link solo si tiene slug (Printful) -->
                                                        <a *ngIf="cart.product?.slug" href="#" class="fw-normal d-inline-block" onclick="return false;" [routerLink]="['/', this.country, this.locale, 'shop', 'product', cart.product.slug]">{{ cart.product.title }}</a>
                                                        <!-- Texto simple para m贸dulos (sin slug) -->
                                                        <span *ngIf="!cart.product?.slug" class="fw-normal">{{ cart.product?.title || 'M贸dulo' }}</span>
                                                    </div>
                                                    <div class="">
                                                        <!-- Mostrar precio con descuento si aplica -->
                                                        <ng-container *ngIf="hasCartItemDiscount(cart); else normalPrice">
                                                            <!-- Precio original tachado -->
                                                            <span class="price-small old-price text-decoration-line-through fw-normal">
                                                                <span class="">
                                                                    <span class="me-1">{{ euro }}</span>
                                                                    <span>{{ getFormattedPrice(cart.variedad?.retail_price || cart.price_unitario).integerPart }}.{{ getFormattedPrice(cart.variedad?.retail_price || cart.price_unitario).decimalPart }}</span>
                                                                </span>
                                                            </span>
                                                            <!-- Precio final con descuento -->
                                                            <span class="money text-danger">
                                                                <span class="price-small fw-normal">
                                                                    <span class="me-1">{{ euro }}</span>
                                                                    <span>{{ getFormattedPrice(getFinalUnitPrice(cart)).integerPart }}.{{ getFormattedPrice(getFinalUnitPrice(cart)).decimalPart }}</span>
                                                                </span>
                                                            </span>
                                                        </ng-container>

                                                        <!-- Precio normal sin descuento -->
                                                        <ng-template #normalPrice>
                                                            <span class="money">
                                                                <span class="price-small fw-normal">
                                                                    <span class="me-1">{{ euro }}</span>
                                                                    <span>{{ getFormattedPrice(cart.variedad?.retail_price || cart.price_unitario).integerPart }}.{{ getFormattedPrice(cart.variedad?.retail_price || cart.price_unitario).decimalPart }}</span>
                                                                </span>
                                                            </span>
                                                        </ng-template>
                                                    </div>
                                                </div>
                                                <div class="d-flex fw-light lh-1 mb-1" *ngIf="cart.product?.sku">
                                                    <span class="w-25">Art. N潞</span>
                                                    <span class="ms-lg-3 ms-5">{{ cart.product.sku }}</span>
                                                </div>
                                                <div class="d-flex fw-light lh-1 mb-1" *ngIf="cart.variedad?.color">
                                                    <span class="w-25">Color</span>
                                                    <span class="ms-lg-3 ms-5 fw-light">{{ cart.variedad.color }}</span>
                                                </div>
                                                <div class="d-flex fw-light lh-1 mb-1" *ngIf="cart.variedad">
                                                    <span class="w-25">Talla</span>
                                                    <span class="ms-lg-3 ms-5 fw-light">{{ cart.variedad.valor }}</span>
                                                </div>
                                                <div class="d-flex fw-light lh-1 mb-1">
                                                    <span class="w-25">Cantidad</span>
                                                    <span class="ms-lg-3 ms-5 fw-light">{{ cart.cantidad}}</span>
                                                </div>
                                                <div class="d-flex fw-light lh-1 mb-1">
                                                    <span class="w-25">Total</span>
                                                    <span class="money ms-lg-3 ms-5">
                                                        <span class="text-dangerpaymen">
                                                            <span class="me-1">{{ euro }}</span>
                                                            <span>{{ getFormattedPrice(getFinalUnitPrice(cart) * cart.cantidad).integerPart }}.{{ getFormattedPrice(getFinalUnitPrice(cart) * cart.cantidad).decimalPart }}</span>
                                                        </span>
                                                    </span>
                                                </div>
                                            </div>
                                            <!-- Subtotal -->
                                            <div class="mt-2 d-none">
                                                <div class="fw-bold">
                                                    Subtotal:
                                                    <span class="price-small">
                                                        <span class="price-main-small">{{getFormattedPrice(cart.total).integerPart}}</span>
                                                        <span class="price-decimals-small">
                                                            <sup>{{getFormattedPrice(cart.total).decimalPart}}</sup>
                                                            <span class="currency-symbol-small">{{euro}}</span>
                                                        </span>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Bot贸n eliminar -->
                                        <div style="flex: 0 0 auto" class="d-none">
                                            <a href="#" onclick="return false;" (click)="removeCart(cart)" class="btn btn-secondary cart-remove remove-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Eliminar del carrito">
                                                <i class="icon anm anm-times-r"></i>
                                            </a>
                                        </div>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END CARTS LIST -->
            </div>
            <!-- END BLOQUE: TU CARRITO -->
        </div>
        <!-- ======== END COL DERECHA ======== -->
    </div>


    <!--MiniAddress Drawer-->
    <div id="miniAddress-drawer" class="minicart-right-drawer offcanvas offcanvas-end" tabindex="-1">
        <!--MiniCart Empty-->
        <div id="cartEmpty" class="cartEmpty d-flex-justify-center flex-column text-center p-3 text-muted d-none">
            <div class="minicart-header d-flex-center justify-content-between w-100">
                <h4 class="fs-6">Your cart (0 Items)</h4>
                <button class="close-cart border-0" data-bs-dismiss="offcanvas" aria-label="Close">
                    <i class="icon anm anm-times-r" data-bs-toggle="tooltip" data-bs-placement="left" title="Close"></i>
                </button>
            </div>
            <div class="cartEmpty-content mt-4">
                <i class="icon anm anm-cart-l fs-1 text-muted"></i>
                <p class="my-3">No Products in the Cart</p>
                <a href="index.html" class="btn btn-primary cart-btn">Continue shopping</a>
            </div>
        </div>
        <!--End MiniCart Empty-->
        <!--MiniCart Content-->
        <div id="cart-drawer" class="block block-cart" *ngIf="listAddresses.length > 0">
            <div class="minicart-header">
                <button class="close-cart border-0" data-bs-dismiss="offcanvas" aria-label="Close">
                    <i class="icon anm anm-times-r" data-bs-toggle="tooltip" data-bs-placement="left" title="Close"></i>
                </button>
                <h4 class="fs-6 text-uppercase fw-bold">
                    Direcci贸n de env铆o ({{ listAddresses.length }})
                </h4>
            </div>
            <div class="minicart-content d-flex">
                <ng-container *ngIf="listCarts.length == 0; else allCarts">
                    <div class="d-flex align-items-center">
                        <div class="p-2 w-100 d-flex flex-column justify-content-center text-center">
                            <div class="inner mb-3 d-none">
                                <div class="bradcrumb-thumb">
                                    <img src="assets/images/favicon.png" alt="Image" style="width: 50px; height: 50px" />
                                </div>
                            </div>
                            <h5 class="header-title mb-0 text-uppercase">
                                隆Oops! Tu carrito est谩 vac铆o
                            </h5>
                            <p>Empieza a llenarlo con cosas que te encantar谩n.</p>
                        </div>
                    </div>
                </ng-container>
                <ng-template #allCarts>
                    <ul class="m-0 clearfix w-100">
                        <ng-container *ngFor="let list_address of listAddresses; let i = index">
                            <div class="payment-accordion-radio">
                                <div class="accordion" id="accordionExample">
                                    <div class="accordion-item card mb-2 p-3">
                                        <div class="card-header" [id]="'heading' + i">
                                            <div class="d-flex flex-row justify-content-between">
                                                <div>
                                                    <div class="card-link">
                                                        <span class="customRadio clearfix mb-0">
                                                            <input id="paymentRadio{{ i }}" [value]="list_address.id" name="payment" type="radio" class="radio" [(ngModel)]="selectedAddressId" (change)="onAddressChange(list_address.id)" />
                                                            <label for="paymentRadio{{ i }}" class="mb-0 text-uppercase fw-bold">
                                                                {{
                                       list_address.name + " " + list_address.surname
                                       }}
                                                            </label>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <a href="#" onclick="return false;" (click)="editAddressFromSidebar(list_address)">
                                                        <button type="button" class="border-0 fw-bold text-decoration-underline">
                                                            Editar
                                                        </button>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        <div [id]="'collapse' + i" class="accordion-collapse collapse show" aria-labelledby="'heading' + i" data-bs-parent="#accordionExample">
                                            <div class="card-body p-0">
                                                <p class="fw-light mb-0">{{ list_address.address }}</p>
                                                <p class="fw-light mb-0">
                                                    {{ list_address.zipcode }} {{ list_address.poblacion }},
                                                    <span class="text-uppercase">{{
                                    list_address.ciudad
                                    }}</span>
                                                    <br />
                                                </p>
                                                <p class="fw-light mb-0">
                                                    Tel. +34 {{ list_address.phone }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-container>
                    </ul>
                </ng-template>
            </div>
            <div class="minicart-bottom" *ngIf="listAddressClients.length != 0 || listAddressGuest.length != 0">
                <div class="minicart-action d-flex flex-column mt-3">
                    <button class="cart-btn btn-dark-ld me-1 py-3 mb-3" (click)="confirmarDireccion()">
                        {{ requiresShipping() ? 'Confirmar direcci贸n' : 'Continuar al pago' }}
                    </button>
                    <a *ngIf="CURRENT_USER_AUTHENTICATED" href="#" onclick="return false;" (click)="showNewAddressForm(); closeMiniAdress()" class="cart-btn btn-outline-white-ld text-black me-1 py-3 mb-3">
                        <i class="icon anm anm-plus-l me-2"></i>A帽adir otra direcci贸n
                    </a>
                    <!-- <a [href]="'/' + locale + '/' + country + '/shop/cart'" class="cart-btn btn btn-outline-white text-black bg-white w-100 me-1 btn-lg text-uppercase fw-normal py-3 mb-3">A帽adir otra direcci贸n</a> -->
                    <!-- <a href="#" onclick="return false;" (click)="goToRegisterAddress()"> 
               <button type="button" class="btn btn-primary px-5 text-uppercase fw-normal">A帽adir otra direcci贸n</button>
               </a> -->
                    <!-- <a href="#" onclick="return false;" [routerLink]="['/', locale, country, 'account', 'myaddresses', 'add']" (click)="goToRegisterAddress()">  -->
                </div>
            </div>
        </div>
        <!--MiniCart Content-->
    </div>
    <!--End MiniCart Drawer-->