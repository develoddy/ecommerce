<!-- üé® LOADING PREMIUM - Procesando pago con seguridad -->
<div *ngIf="loading" class="payment-loading-overlay">
    <div class="loading-container">
        <!-- Animated Icon Container -->
        <div class="icon-animation-wrapper">
            <!-- Pulsating background circles (m√∫ltiples capas) -->
            <div class="pulse-circle pulse-circle-1"></div>
            <div class="pulse-circle pulse-circle-2"></div>
            <div class="pulse-circle pulse-circle-3"></div>
            
            <!-- Main Icon -->
            <div class="main-icon">üí≥</div>
            
            <!-- Rotating border -->
            <div class="spinner-border spinner-custom" role="status">
                <span class="visually-hidden">Procesando pago seguro...</span>
            </div>
            
            <!-- Success checkmark (aparece al final) -->
            <div class="success-checkmark">
                <div class="check-icon">
                    <span class="icon-line line-tip"></span>
                    <span class="icon-line line-long"></span>
                    <div class="icon-circle"></div>
                    <div class="icon-fix"></div>
                </div>
            </div>
        </div>
        
        <!-- Loading Progress Steps -->
        <div class="loading-steps">
            <h3 class="loading-title">
                Procesando tu pago de forma segura
            </h3>
            
            <!-- Progress Bar Mejorada -->
            <div class="progress-wrapper">
                <div class="progress-bar-custom">
                    <div class="progress-fill"></div>
                    <div class="progress-glow"></div>
                </div>
                <div class="progress-percentage">
                    <span class="percentage-text"></span>
                </div>
            </div>
            
            <!-- Status Messages con rotaci√≥n -->
            <div class="status-messages">
                <p class="status-message status-active">
                    <i class="icon anm anm-lock status-icon"></i>
                    Verificando datos de pago...
                </p>
                <p class="status-message">
                    <i class="icon anm anm-shield status-icon"></i>
                    Conectando con pasarela segura...
                </p>
                <p class="status-message">
                    <i class="icon anm anm-check-circle-o status-icon"></i>
                    Confirmando transacci√≥n...
                </p>
                <p class="status-message">
                    <i class="icon anm anm-envelope-l status-icon"></i>
                    Enviando confirmaci√≥n por email...
                </p>
            </div>
        </div>
        
        <!-- Security Badges Mejorados -->
        <div class="security-badges">
            <div class="badge-item badge-animate">
                <div class="badge-icon badge-icon-success">
                    <i class="icon anm anm-lock"></i>
                </div>
                <div class="badge-content">
                    <small class="badge-label">Conexi√≥n segura</small>
                    <strong class="badge-value">SSL 256-bit</strong>
                </div>
            </div>
            <div class="badge-item badge-animate" style="animation-delay: 0.2s;">
                <div class="badge-icon badge-icon-primary">
                    <i class="icon anm anm-shield"></i>
                </div>
                <div class="badge-content">
                    <small class="badge-label">Cifrado</small>
                    <strong class="badge-value">Stripe & PayPal</strong>
                </div>
            </div>
            <div class="badge-item badge-animate" style="animation-delay: 0.4s;">
                <div class="badge-icon badge-icon-warning">
                    <i class="icon anm anm-check-circle-o"></i>
                </div>
                <div class="badge-content">
                    <small class="badge-label">Verificado</small>
                    <strong class="badge-value">PCI DSS</strong>
                </div>
            </div>
        </div>
        
        <!-- Helper Text Mejorado -->
        <div class="helper-text-wrapper">
            <div class="helper-icon">
                <i class="icon anm anm-info-circle"></i>
            </div>
            <div class="helper-content">
                <p class="helper-title">Por favor, mant√©n esta ventana abierta</p>
                <p class="helper-description">
                    Tu pago se est√° procesando de forma segura. Recibir√°s un email de confirmaci√≥n en unos segundos.
                </p>
            </div>
        </div>
        
        <!-- Estimated Time -->
        <div class="estimated-time">
            <div class="time-icon-wrapper">
                <i class="icon anm anm-clock-o time-icon"></i>
            </div>
            <span class="time-text">Tiempo estimado: <strong>10-30 segundos</strong></span>
        </div>
    </div>
</div>

<div [ngClass]="{'tab-pane': true, 'active': isLastStepActive_4 && isSaleSuccess}" id="steps4" [class.d-none]="loading">
    <ng-container>
        <!--Order success-->
        <!-- ORDER SUCCESS -->
        <div class="success-text checkout-card text-center mb-md-5">
            <!-- Animaci√≥n de confirmaci√≥n -->
            <div class="position-relative d-inline-block mb-4">
                <i class="icon anm anm-check-circle-o d-block" style="font-size: 5rem; color: #28a745;"></i>
            </div>
            
            <h1 class="mb-3" style="color: #000; font-size: 2.2rem; font-weight: 700; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                ¬°Gracias por tu compra!
            </h1>
            <p class="mb-2 text-success" style="font-size: 1.2rem; font-weight: 600; max-width: 600px; margin: 0 auto;">
                ‚úÖ Tu pago se ha realizado con √©xito
            </p>
            <p class="mb-4 text-muted" style="font-size: 1rem; max-width: 600px; margin: 0 auto;">
                <i class="icon anm anm-truck-l me-2 text-primary"></i>
                Tu pedido est√° en camino y lo recibir√°s pronto. Recibir√°s un correo con todos los detalles.
            </p>
            
            <!-- N√∫mero de pedido mejorado -->
            <div class="d-flex align-items-center justify-content-center px-3 py-3 mt-3 mb-4 mx-auto" *ngIf="this.sale" style="background: #28a745; border-radius: 12px; box-shadow: 0 4px 16px rgba(40, 167, 69, 0.2); max-width: 400px; overflow: hidden;">
                <i class="icon anm anm-file-text-l me-3 flex-shrink-0" style="color: #fff; font-size: 1.5rem;"></i>
                <div class="text-start min-w-0 flex-grow-1">
                    <small class="d-block text-white-50" style="font-size: 0.75rem; letter-spacing: 0.5px; text-transform: uppercase;">N√∫mero de Pedido</small>
                    <strong class="d-block text-white text-truncate" style="font-size: 1.1rem; letter-spacing: 0.5px; font-family: 'Courier New', monospace;" *ngIf="sale.printfulOrderId" [title]="'#PF' + sale.printfulOrderId">#PF{{ sale.printfulOrderId }}</strong>
                    <strong class="d-block text-white text-truncate" style="font-size: 1.1rem; letter-spacing: 0.5px; font-family: 'Courier New', monospace;" *ngIf="!sale.printfulOrderId" [title]="sale.n_transaction">{{ sale.n_transaction }}</strong>
                </div>
            </div>
            
            <!-- üéØ Primary Action: Track Order (CTA Principal) -->
            <div class="text-center mt-4 mb-3">
                <button class="btn btn-dark btn-lg px-5 py-3 d-inline-flex align-items-center justify-content-center" 
                        style="background: #000000; 
                               border: none; 
                               border-radius: 8px; 
                               font-weight: 600; 
                               letter-spacing: 0.5px; 
                               font-size: 1.1rem;
                               min-width: 280px;
                               box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
                               transition: all 0.3s ease;"
                        (click)="navigateToTrackOrder()">
                    <span style="font-size: 1.3rem; margin-right: 10px;">üì¶</span>
                    <span>Seguir mi pedido</span>
                </button>
            </div>
            
            <!-- üí¨ Secondary Action: Support (Acci√≥n secundaria) -->
            <div class="text-center mt-3 mb-4">
                <small class="d-block text-muted mb-2" style="font-size: 0.875rem;">
                    ¬øNecesitas ayuda con tu pedido?
                </small>
                <a [href]="'mailto:soporte@lujandev.com?subject=Consulta sobre pedido ' + (sale?.printfulOrderId ? '#PF' + sale.printfulOrderId : sale?.n_transaction)" 
                   class="text-decoration-none" 
                   style="color: #28a745; font-weight: 500; font-size: 0.95rem;">
                    <i class="icon anm anm-envelope-l me-1" style="font-size: 1rem;"></i>
                    <span>Contactar soporte</span>
                </a>
            </div>
        </div>
        <!-- END ORDER SUCCESS -->

        <div class="row checkout-form">
            <!-- ITEMS CARTS COMPRAS -->
            <div class="col-12 col-sm-12 col-md-12 col-lg-12" [ngClass]="{'mb-5': isDesktop, 'mb-2': isMobile}">
                <div class="row">
                    <!-- ORDER -->
                    <div class="col-12 col-lg-8 p-0">
                        <div class="block order-summary p-2 mb-5">
                            <div class="block-content">
                                <h3 class="mb-3 text-uppercase" style="color: #222; font-size: 1.25rem; letter-spacing: 0.5px; border-bottom: 2px solid #222; padding-bottom: 0.5rem;">
                                    <i class="icon anm anm-check-cil me-2"></i>Resumen del pedido
                                </h3>
                                <div class="row">
                                    <!-- CART CONTENT -->
                                    <div class="col-12 col-sm-12 col-md-12 col-lg-12 main-col">
                                        <!-- LIST CARTS -->
                                        <div class="d-flex flex-column gap-3">
                                            <ng-container *ngFor="let sale of saleDetails">
                                                <div class="product-card p-3" style="background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid #f0f0f0;">
                                                    <div class="d-flex flex-column flex-md-row align-items-start gap-3">
                                                        <!-- PRODUCTO IMAGE -->
                                                        <div class="product-image-container" style="min-width: 120px;">
                                                            <a href="#" onclick="return false;" [routerLink]="['/', this.country, this.locale, 'shop', 'product', sale.product.slug]" class="d-block" style="border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                                            <img class="product-image"
                                                                [src]="getImageUrl(sale)"
                                                                [alt]="sale.product?.title || sale.product?.name || 'product'"
                                                                [title]="sale.product?.title || sale.product?.name || 'Product'"
                                                                width="120"
                                                                height="120"
                                                                style="object-fit: cover; border-radius: 8px;"
                                                            />
                                                        </a>
                                                    </div>
                                                        <!--  END PRODUCTO IMAGE -->
                                                        
                                                        <!-- DETALLES DEL PRODUCTO -->
                                                        <div class="flex-grow-1">
                                                            <!-- TITULO DEL PRODUCTO-->
                                                            <div class="mb-2">
                                                                <a class="text-decoration-none" [routerLink]="['/', this.country, this.locale, 'shop', 'product', sale.product.slug]">
                                                                    <h5 class="mb-1" style="color: #2c3e50; font-weight: 600; font-size: 1.1rem;">{{ sale.product.title }}</h5>
                                                                </a>
                                                            </div>

                                                        <!-- PRECIO DEL PRODUCTO -->
                                                        <div class="mb-2 lh-1">
                                                            <!-- Si tiene descuento real, mostrar precio original tachado y precio final -->
                                                            <ng-container *ngIf="hasProductDiscount(sale); else normalPrice">
                                                                <!-- Precio original tachado -->
                                                                <span class="money me-2">
                                                                    <span class="price-small old-price text-decoration-line-through">
                                                                        <span class="me-1">{{ euro }}</span>
                                                                        <span class="">{{ getFormattedPrice(sale.variedade?.retail_price || sale.price_unitario).integerPart }}.</span>
                                                                        <span class="">
                                                                            <span>{{ getFormattedPrice(sale.variedade?.retail_price || sale.price_unitario).decimalPart }}</span>
                                                                        </span>
                                                                    </span>
                                                                </span>
                                                                <!-- Precio con descuento -->
                                                                <span class="money">
                                                                    <span class="price-small text-danger">
                                                                        <span class="me-1">{{ euro }}</span>
                                                                        <span class="">{{ getFormattedPrice(getFinalUnitPrice(sale)).integerPart }}.</span>
                                                                        <span class="">
                                                                            <span>{{ getFormattedPrice(getFinalUnitPrice(sale)).decimalPart }}</span>
                                                                        </span>
                                                                    </span>
                                                                </span>
                                                            </ng-container>
                                                            <!-- Si no tiene descuento, mostrar precio normal -->
                                                            <ng-template #normalPrice>
                                                                <span class="money">
                                                                    <span class="price-small">
                                                                        <span class="me-1">{{ euro }}</span>
                                                                        <span class="">{{ getFormattedPrice(getFinalUnitPrice(sale)).integerPart }}.</span>
                                                                        <span class="">
                                                                            <span>{{ getFormattedPrice(getFinalUnitPrice(sale)).decimalPart }}</span>
                                                                        </span>
                                                                    </span>
                                                                </span>
                                                            </ng-template>
                                                        </div>
                                                        
                                                            <!-- ATRIBUTOS DEL PRODUCTO -->
                                                            <div class="product-attributes mb-3">
                                                                <div class="row g-2">
                                                                    <div class="col-6 col-md-4">
                                                                        <div class="d-flex align-items-center">
                                                                            <div class="attribute-icon me-2" style="width: 20px; height: 20px; background: #e3f2fd; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                                                <i class="icon anm anm-palette" style="font-size: 0.7rem; color: #1976d2;"></i>
                                                                            </div>
                                                                            <div>
                                                                                <small class="text-muted d-block" style="font-size: 0.75rem;">Color</small>
                                                                                <span class="fw-medium" style="font-size: 0.85rem;">{{ sale.variedade.color }}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-6 col-md-4" *ngIf="sale.variedade">
                                                                        <div class="d-flex align-items-center">
                                                                            <div class="attribute-icon me-2" style="width: 20px; height: 20px; background: #f3e5f5; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                                                <i class="icon anm anm-expand" style="font-size: 0.7rem; color: #7b1fa2;"></i>
                                                                            </div>
                                                                            <div>
                                                                                <small class="text-muted d-block" style="font-size: 0.75rem;">Talla</small>
                                                                                <span class="fw-medium" style="font-size: 0.85rem;">{{ sale.variedade.valor }}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-6 col-md-4">
                                                                        <div class="d-flex align-items-center">
                                                                            <div class="attribute-icon me-2" style="width: 20px; height: 20px; background: #e8f5e8; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                                                <i class="icon anm anm-plus-l" style="font-size: 0.7rem; color: #2e7d32;"></i>
                                                                            </div>
                                                                            <div>
                                                                                <small class="text-muted d-block" style="font-size: 0.75rem;">Cantidad</small>
                                                                                <span class="fw-medium" style="font-size: 0.85rem;">{{ sale.cantidad }}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        
                                                            <!-- TOTAL DEL PRODUCTO -->
                                                            <div class="product-total d-flex justify-content-between align-items-center p-2" style="background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                                                                <span class="fw-semibold text-success" style="font-size: 0.9rem;">Total del producto:</span>
                                                                <span class="money fw-bold" style="font-size: 1.1rem; color: #28a745;">
                                                                    <span class="me-1">{{ euro }}</span>
                                                                    <span>{{ getFormattedPrice(getFinalUnitPrice(sale) * sale.cantidad).integerPart }}.</span>
                                                                    <span>{{ getFormattedPrice(getFinalUnitPrice(sale) * sale.cantidad).decimalPart }}</span>
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </div>
                                        <!-- END LIST CARTS -->
                                    </div>
                                    <!-- END CART CONTENT -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END ORDER -->

                    <!-- CART SUMMARY -->
                    <div class="col-12 col-sm-12 col-md-12 col-lg-4 mt-5 mt-lg-0">
                        <div class="cart-info sidebar-sticky" style="background: #ffffff; border: 1px solid #e9ecef; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                            <h3 class="mb-4 text-center" style="color: #2c3e50; font-size: 1.4rem; font-weight: 700; letter-spacing: 0.5px; border-bottom: 3px solid #28a745; padding-bottom: 0.75rem; text-transform: uppercase;">
                                <i class="icon anm anm-calculator me-2" style="color: #28a745;"></i>Resumen Final
                            </h3>
                            <div class="cart-order-detail cart-col">
                                <!-- SUBTOTAL -->
                                <ng-container *ngIf="saleDetails && saleDetails.length > 0">
                                    <!-- Subtotal -->
                                    <div class="row g-0">
                                        <span class="col-6 col-sm-6 cart-subtotal-title fw-light">Subtotal</span>
                                        <span class="col-6 col-sm-6 cart-subtotal-title cart-subtotal text-end">
                                            <!-- Mostrar subtotal original solo si hay descuentos, sino mostrar subtotal final -->
                                            <ng-container *ngIf="hasAnyCartDiscount(); else noDiscountSubtotal">
                                                <span class="price-small fw-light old-price text-decoration-line-through">
                                                    <span class="me-1">{{ euro }}</span>
                                                    <span class="">{{ getFormattedPrice(getOriginalSubtotal()).integerPart }}.</span>
                                                    <span class="">
                                                        <span>{{ getFormattedPrice(getOriginalSubtotal()).decimalPart }}</span>
                                                    </span>
                                                </span>
                                            </ng-container>
                                            <ng-template #noDiscountSubtotal>
                                                <span class="price-small fw-light">
                                                    <span class="me-1">{{ euro }}</span>
                                                    <span class="">{{ getFormattedPrice(getSubtotal()).integerPart }}.</span>
                                                    <span class="">
                                                        <span>{{ getFormattedPrice(getSubtotal()).decimalPart }}</span>
                                                    </span>
                                                </span>
                                            </ng-template>
                                        </span>
                                    </div>
                                    
                                    <!-- Descuento aplicado (solo si hay descuentos) -->
                                    <div class="row g-0" *ngIf="hasAnyCartDiscount()">
                                        <span class="col-6 col-sm-6 cart-subtotal-title fw-light text-danger">Descuento</span>
                                        <span class="col-6 col-sm-6 cart-subtotal-title cart-subtotal text-end text-danger">
                                            <span class="price-small fw-light">
                                                <span class="me-1">{{ euro }}</span>
                                                -<span class="">{{ getFormattedPrice(getTotalDiscount()).integerPart }}.</span>
                                                <span class="">
                                                    <span>{{ getFormattedPrice(getTotalDiscount()).decimalPart }}</span>
                                                </span>
                                            </span>
                                        </span>
                                    </div>
                                </ng-container>
                                <!-- END SUBTOTAL -->
                                
                                <!-- ENV√çO GRATIS -->
                                <div class="row g-0 mb-2">
                                    <span class="col-6 col-sm-6 cart-subtotal-title fw-light">Env√≠o</span>
                                    <span class="col-6 col-sm-6 cart-subtotal-title cart-subtotal text-end"><span class="money fw-light">Gratis</span></span>
                                </div>
                                <!-- END ENV√çO GRATIS -->
                                
                                <!-- TOTAL -->
                                <div class="row g-0">
                                    <span class="col-6 col-sm-6 cart-subtotal-title fs-5 text-uppercase fw-bold">Total</span>
                                    <span class="col-6 col-sm-6 cart-subtotal-title fs-5 cart-subtotal text-end">
                                        <span class="money price fw-bold">
                                            <span class="me-1">{{ euro }}</span>
                                            <span class="">{{ getFormattedPrice(getTotal()).integerPart }}.</span>
                                            <span class="">
                                                <span>{{ getFormattedPrice(getTotal()).decimalPart }}</span>
                                            </span>
                                        </span>
                                    </span>
                                </div>
                                <!-- END TOTAL -->
                                
                                <!-- IMPUESTOS INCLUIDOS -->
                                <div class="row g-0 d-none">
                                    <div class="col-6 col-sm-6 text-center">
                                        <small class="text-muted fw-light">Impuestos incluidos</small>
                                    </div>
                                </div>
                                <!-- END IMPUESTOS INCLUIDOS -->

                                <!-- PAY METHODS CARDS -->
                                <div class="d-flex mb-3">
                                    <ul class="d-flex flex-row">
                                        <li class="ms-0"><svg  width="44" height="28" xmlns="http://www.w3.org/2000/svg" class="Icon_icon-content-1__kPDLF"><title  lang="en">Visa</title><path  fill="#1434CB" d="M27.787 8.02c-2.809 0-5.32 1.456-5.32 4.146 0 3.085 4.453 3.298 4.453 4.847 0 .653-.748 1.237-2.025 1.237-1.813 0-3.168-.816-3.168-.816l-.58 2.714s1.561.69 3.633.69c3.071 0 5.488-1.528 5.488-4.264 0-3.26-4.47-3.466-4.47-4.904 0-.511.613-1.072 1.887-1.072 1.437 0 2.61.594 2.61.594l.566-2.622s-1.275-.55-3.074-.55m-25.699.198-.068.396s1.182.216 2.246.647c1.37.495 1.468.783 1.699 1.678l2.515 9.695h3.371l5.194-12.416h-3.364l-3.337 8.441-1.362-7.155c-.125-.819-.757-1.286-1.532-1.286zm16.31 0-2.639 12.416h3.208l2.629-12.416zm17.89 0c-.774 0-1.184.414-1.485 1.138l-4.699 11.278h3.364l.65-1.88h4.098l.396 1.88h2.968L38.99 8.218zm.437 3.354.997 4.66H35.05l1.674-4.66Z"></path></svg></li>
                                        <li class="ms-2"><svg  width="44" height="28" xmlns="http://www.w3.org/2000/svg" viewBox="7 -2 31 31" class="Icon_icon-content-1__kPDLF"><title  lang="en">Mastercard</title><path  d="M12.601 25.947v-1.592c0-.61-.371-1.009-1.008-1.009-.319 0-.665.105-.903.452-.186-.29-.452-.452-.85-.452a.86.86 0 0 0-.743.372v-.319H8.54v2.548h.557V24.54c0-.451.238-.665.61-.665.37 0 .556.238.556.665v1.407h.557V24.54c0-.451.266-.665.609-.665.371 0 .557.238.557.665v1.407zm8.258-2.548h-.903v-.77h-.557v.77h-.504v.504h.504v1.17c0 .584.238.927.875.927.238 0 .504-.08.69-.186l-.16-.479a.9.9 0 0 1-.48.133c-.266 0-.371-.16-.371-.424v-1.14h.903v-.505zm4.726-.056a.76.76 0 0 0-.665.371v-.318h-.557v2.548h.557V24.51c0-.423.185-.665.532-.665.105 0 .238.028.346.053l.16-.532c-.11-.022-.268-.022-.373-.022Zm-7.142.266c-.266-.185-.637-.266-1.036-.266-.637 0-1.06.319-1.06.823 0 .424.318.665.875.742l.266.028c.29.053.451.133.451.266 0 .186-.213.319-.584.319-.372 0-.665-.133-.85-.266l-.267.423c.29.214.69.319 1.089.319.742 0 1.169-.346 1.169-.823 0-.451-.346-.69-.875-.77l-.266-.028c-.239-.028-.424-.08-.424-.238 0-.185.185-.29.48-.29.318 0 .636.132.797.213zm14.812-.266a.76.76 0 0 0-.665.371v-.318h-.557v2.548h.557V24.51c0-.423.185-.665.532-.665.105 0 .238.028.346.053l.16-.526c-.107-.028-.265-.028-.373-.028Zm-7.114 1.33c0 .77.532 1.327 1.355 1.327.371 0 .637-.08.903-.29l-.266-.452c-.213.16-.424.238-.665.238-.451 0-.77-.319-.77-.823 0-.48.319-.798.77-.822.238 0 .452.08.665.238l.266-.452c-.266-.213-.532-.29-.903-.29-.823-.004-1.355.556-1.355 1.326m5.15 0V23.4h-.557v.319c-.186-.239-.452-.372-.798-.372-.717 0-1.274.557-1.274 1.327s.557 1.327 1.274 1.327c.371 0 .637-.133.798-.371v.318h.557v-1.274Zm-2.045 0c0-.451.291-.822.77-.822.452 0 .77.346.77.822 0 .452-.318.823-.77.823-.476-.028-.77-.374-.77-.823m-6.661-1.33c-.743 0-1.275.532-1.275 1.327 0 .798.532 1.327 1.302 1.327a1.62 1.62 0 0 0 1.037-.346l-.267-.4a1.26 1.26 0 0 1-.742.266c-.346 0-.69-.16-.77-.609h1.884v-.213c.024-.82-.455-1.352-1.17-1.352Zm0 .48c.346 0 .584.213.637.609h-1.327c.052-.343.29-.61.69-.61Zm13.83.85v-2.282h-.556v1.327c-.186-.239-.452-.372-.798-.372-.718 0-1.274.557-1.274 1.327S34.343 26 35.061 26c.371 0 .637-.133.798-.371v.318h.556zm-2.044 0c0-.451.29-.822.77-.822.452 0 .77.346.77.822 0 .452-.318.823-.77.823-.48-.028-.77-.374-.77-.823m-18.637 0V23.4h-.557v.319c-.185-.239-.451-.372-.798-.372-.717 0-1.274.557-1.274 1.327s.557 1.327 1.274 1.327c.372 0 .638-.133.798-.371v.318h.557v-1.274Zm-2.069 0c0-.451.29-.822.77-.822.452 0 .77.346.77.822 0 .452-.318.823-.77.823-.48-.028-.77-.374-.77-.823"></path><path  fill="#FF5A00" d="M26.62 4.044h-8.362V19.07h8.363V4.044Z"></path><path  fill="#EB001B" d="M18.814 11.557a9.58 9.58 0 0 1 3.637-7.513A9.5 9.5 0 0 0 16.557 2 9.55 9.55 0 0 0 7 11.557a9.55 9.55 0 0 0 9.557 9.556c2.23 0 4.274-.77 5.895-2.044a9.54 9.54 0 0 1-3.638-7.512"></path><path  fill="#F79E1B" d="M37.903 11.557a9.55 9.55 0 0 1-9.557 9.556c-2.23 0-4.274-.77-5.895-2.044a9.5 9.5 0 0 0 3.638-7.512 9.58 9.58 0 0 0-3.637-7.513A9.5 9.5 0 0 1 28.343 2c5.286 0 9.56 4.302 9.56 9.557"></path></svg></li>
                                        <li class="ms-2"><svg  width="64" height="32" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="Icon_icon-content-1__kPDLF"><g  fill-rule="evenodd" clip-rule="evenodd"><path  fill="#009EE3" d="M7.236 12.422h4.1c2.2 0 3.03 1.114 2.902 2.751-.212 2.703-1.846 4.199-4.014 4.199H9.13c-.297 0-.497.197-.578.73l-.464 3.1c-.031.202-.137.318-.296.334H5.216c-.242 0-.328-.185-.264-.586l1.57-9.941c.062-.398.28-.587.714-.587"></path><path  fill="#113984" d="M25.036 12.237c1.383 0 2.66.75 2.485 2.62-.212 2.223-1.403 3.453-3.281 3.458h-1.642c-.236 0-.35.193-.411.588l-.318 2.018c-.047.305-.204.455-.435.455h-1.527c-.243 0-.328-.155-.274-.504l1.26-8.088c.063-.398.212-.547.484-.547zm-2.487 4.331h1.243c.778-.03 1.294-.568 1.346-1.54.032-.6-.373-1.03-1.018-1.026l-1.17.005zm9.123 4.189c.14-.127.282-.193.262-.036l-.05.375c-.025.195.052.3.234.3h1.357c.228 0 .34-.093.396-.446l.836-5.248c.042-.263-.023-.392-.223-.392h-1.492c-.134 0-.2.075-.235.28l-.055.323c-.028.168-.106.198-.178.029-.252-.6-.898-.868-1.799-.847-2.092.043-3.503 1.632-3.654 3.668-.117 1.575 1.012 2.812 2.5 2.812 1.08 0 1.562-.317 2.106-.815zm-1.136-.808c-.9 0-1.528-.718-1.398-1.599.13-.88.972-1.599 1.873-1.599.9 0 1.528.719 1.398 1.6-.13.88-.971 1.599-1.873 1.599Zm6.826-4.656h-1.376c-.283 0-.399.212-.309.472l1.708 5.002-1.675 2.38c-.14.199-.032.38.166.38h1.546a.47.47 0 0 0 .46-.226l5.253-7.535c.162-.232.086-.475-.18-.475h-1.463c-.251 0-.352.1-.496.308l-2.19 3.175-.98-3.183c-.056-.192-.2-.298-.463-.298z"></path><path  fill="#009EE3" d="M48.6 12.237c1.384 0 2.66.75 2.485 2.62-.211 2.223-1.402 3.453-3.28 3.458h-1.64c-.237 0-.351.193-.413.588l-.317 2.018c-.048.305-.204.455-.435.455h-1.527c-.244 0-.328-.155-.274-.504l1.262-8.09c.063-.399.212-.547.484-.547H48.6zm-2.487 4.331h1.244c.778-.03 1.294-.568 1.346-1.54.032-.6-.373-1.03-1.018-1.026l-1.17.005zm9.124 4.189c.14-.127.282-.193.262-.036l-.05.375c-.026.195.052.3.234.3h1.357c.228 0 .34-.093.395-.446l.837-5.248c.042-.263-.023-.392-.223-.392h-1.49c-.134 0-.2.075-.235.28l-.055.323c-.029.168-.106.198-.178.029-.253-.6-.898-.868-1.799-.847-2.092.043-3.503 1.632-3.654 3.668-.117 1.575 1.012 2.812 2.5 2.812 1.079 0 1.562-.317 2.106-.815zm-1.135-.808c-.901 0-1.529-.718-1.398-1.599.13-.88.972-1.599 1.873-1.599.9 0 1.528.719 1.398 1.6-.13.88-.973 1.599-1.873 1.599Zm6.258 1.455h-1.567a.184.184 0 0 1-.191-.212l1.376-8.716a.27.27 0 0 1 .26-.212h1.566a.186.186 0 0 1 .192.212l-1.376 8.716a.27.27 0 0 1-.26.214z"></path><path  fill="#113984" d="M4.671 9h4.105c1.155 0 2.527.037 3.443.847.613.54.935 1.4.86 2.328-.251 3.134-2.125 4.89-4.64 4.89H6.415c-.345 0-.572.228-.67.846L5.18 21.51c-.037.233-.137.37-.317.388H2.33c-.28 0-.38-.212-.307-.68l1.82-11.533c.075-.465.33-.685.829-.685Z"></path><path  fill="#172C70" d="m5.805 17.546.716-4.537c.063-.398.28-.588.715-.588h4.1c.678 0 1.227.105 1.657.301-.412 2.79-2.216 4.34-4.578 4.34h-2.02c-.272 0-.47.136-.59.484"></path></g></svg></li>
                                        <li class="ms-2"><svg width="63" height="25" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="Icon_icon-content-1__kPDLF"><g  clip-path="url('#bizum-large-a')"><path  fill="#51555B" fill-rule="evenodd" d="M31.643 13.35c-.5 0-.927.428-.927.891v6.85c0 .499.428.927.927.927s.928-.428.928-.928v-6.813a.92.92 0 0 0-.928-.927m0-3.39c-.57 0-1.034.464-1.034 1.035s.464 1.07 1.034 1.07 1.035-.463 1.035-1.07c.036-.57-.464-1.034-1.035-1.034m9.06 4.317c0-.57-.463-.785-.855-.785H35.21c-.464 0-.821.357-.821.785 0 .464.357.82.82.82h3.033l-3.889 5.423a1.06 1.06 0 0 0-.178.535c0 .57.464.892.856.892h4.887c.464 0 .82-.357.82-.821a.807.807 0 0 0-.82-.82h-3.317l3.817-5.315c.214-.25.285-.5.285-.714m-13.554 4.28c0 1.142-.5 1.82-1.606 1.82-1.141 0-1.605-.678-1.605-1.82v-3.495h1.677c1.355 0 1.534.749 1.534 1.57zm1.855-1.961c0-1.927-1-3.14-3.354-3.14h-1.712v-2.568c0-.5-.428-.927-.892-.927a.944.944 0 0 0-.927.927v7.705c0 1.927 1.034 3.46 3.46 3.46 2.39 0 3.46-1.57 3.46-3.46v-1.962zM47.91 13.35c-.5 0-.928.428-.928.927v4.28c0 1.142-.5 1.82-1.605 1.82-1.142 0-1.605-.678-1.605-1.82v-4.28c0-.5-.428-.927-.892-.927-.5 0-.928.428-.928.927v4.28c0 1.927 1.035 3.46 3.46 3.46 2.39 0 3.46-1.569 3.46-3.46v-4.28c-.035-.5-.463-.927-.962-.927M62 16.845c0-1.926-.892-3.46-3.282-3.46-1.07 0-1.855.321-2.39.856-.535-.499-1.284-.856-2.39-.856-2.39 0-3.282 1.57-3.282 3.46v4.281c0 .5.428.927.892.927.5 0 .928-.428.928-.927v-4.28c0-1.142.356-1.82 1.462-1.82s1.463.678 1.463 1.82v4.28c0 .5.428.927.891.927.5 0 .928-.428.928-.927v-4.28c0-1.142.357-1.82 1.462-1.82 1.106 0 1.463.678 1.463 1.82v4.28c0 .5.428.927.892.927.5 0 .927-.428.927-.927zm-56.718-3.46a1.47 1.47 0 0 0 2.033-.32l1.712-2.355a1.47 1.47 0 0 0-.32-2.033 1.47 1.47 0 0 0-2.034.32l-1.712 2.355c-.464.642-.321 1.534.32 2.033m7.776-3.317a1.47 1.47 0 0 0-2.033.32L4.176 19.77a1.47 1.47 0 0 0 .321 2.034c.642.463 1.57.32 2.033-.321l6.814-9.382c.5-.642.356-1.57-.286-2.033m-8.418-.75a1.47 1.47 0 0 0-.321-2.033c-.642-.463-1.57-.356-2.034.321a1.444 1.444 0 0 0 .321 2.034c.643.463 1.534.32 2.034-.321m10.345 12.878a1.47 1.47 0 0 0-2.034.321 1.47 1.47 0 0 0 .321 2.034 1.47 1.47 0 0 0 2.034-.321c.463-.643.32-1.534-.321-2.034m-2.676-3.71a1.47 1.47 0 0 0-2.033.321l-1.712 2.355a1.47 1.47 0 0 0 .32 2.033c.643.464 1.57.321 2.034-.321l1.712-2.354a1.47 1.47 0 0 0-.32-2.034" clip-rule="evenodd"></path></g><defs ><clipPath  id="bizum-large-a"><path  fill="#fff" d="M2 7h60v17.836H2z"></path></clipPath></defs></svg></li>
                                    </ul>
                                </div>
                                <!-- END PAY METHODS CARDS -->

                                <!-- HELPER USER -->
                                <div>
                                    <p  class="lh-1 fw-light"><small>¬øNecesitas ayuda? Ponte en contacto con el <a  href="#" onclick="return false;" class="text-decoration-underline fw-normal">servicio de Atenci√≥n al cliente</a>.</small></p>
                                </div>
                                <!-- END HELPER USER -->
                            </div>
                        </div>
                    </div>
                    <!-- END CART SUMMARY -->

                </div>                   
            </div>
            <!-- END ITEMS CARTS COMPRAS -->

            <!-- DETAILS COMPRA -->
            <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                <div class="row g-3">
                    <div class="col-12 col-md-6 col-lg-3">
                        <!--Order Address-->
                        <div class="block p-0">
                            <div class="block-content"> 
                                <div class="shipping-details mb-4 mb-sm-0 lh-1">
                                    <h3 class="mb-3 d-flex align-items-center" style="color: #2c3e50; font-size: 1.2rem; font-weight: 600;">
                                        <div class="icon-container me-3" style="width: 32px; height: 32px; background: #007bff; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="icon anm anm-map-marker-al" style="color: white; font-size: 0.9rem;"></i>
                                        </div>
                                        Direcci√≥n de env√≠o
                                    </h3>
                                    <!-- Mostrar desde shippingAddress o desde sale (fallback para PayPal) -->
                                    <ng-container *ngIf="this.shippingAddress || this.sale?.address_client">
                                        <div class="shipping-info p-3" style="background: #f8f9fa; border-radius: 12px; border-left: 4px solid #007bff;">
                                            <div class="mb-2 d-flex align-items-center">
                                                <i class="icon anm anm-user me-2 text-primary"></i>
                                                <strong style="color: #2c3e50;">
                                                    {{ (shippingAddress?.name || sale?.address_client?.name) }} 
                                                    {{ (shippingAddress?.surname || sale?.address_client?.surname) }}
                                                </strong>
                                            </div>
                                            <div class="mb-2 d-flex align-items-start">
                                                <i class="icon anm anm-map-marker-al me-2 text-primary mt-1"></i>
                                                <div>
                                                    <div>{{ shippingAddress?.address || sale?.address_client?.address }}</div>
                                                    <div>
                                                        {{ shippingAddress?.zipcode || sale?.address_client?.zipcode }} 
                                                        {{ shippingAddress?.poblacion || sale?.address_client?.poblacion }}, 
                                                        {{ shippingAddress?.ciudad || sale?.address_client?.ciudad }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-2 d-flex align-items-center">
                                                <i class="icon anm anm-phone me-2 text-primary"></i>
                                                <span>{{ shippingAddress?.phone || sale?.address_client?.phone }}</span>
                                            </div>
                                            <div class="mt-3">
                                                <span class="badge bg-primary" style="font-size: 0.75rem;">üìç Direcci√≥n de env√≠o</span>
                                            </div>
                                        </div>
                                    </ng-container>
                                    <!-- Mensaje si no hay direcci√≥n disponible -->
                                    <ng-container *ngIf="!this.shippingAddress && !this.sale?.address_client">
                                        <div class="alert alert-info" style="border-radius: 12px;">
                                            <i class="icon anm anm-info-circle me-2"></i>
                                            <small>Cargando informaci√≥n de env√≠o...</small>
                                        </div>
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                        <!--Order Address-->    
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="block p-0">
                            <div class="block-content">
                                <div class="billing-details">
                                    <h3 class="mb-3 d-flex align-items-center" style="color: #2c3e50; font-size: 1.2rem; font-weight: 600;">
                                        <div class="icon-container me-3" style="width: 32px; height: 32px; background: #28a745; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="icon anm anm-credit-card-l" style="color: white; font-size: 0.9rem;"></i>
                                        </div>
                                        M√©todo de pago
                                    </h3>
                                    <ng-container *ngIf="this.sale">
                                        <div class="payment-info p-3" style="background: #f8f9fa; border-radius: 12px; border-left: 4px solid #28a745;">
                                            <div class="d-flex align-items-center">
                                                <i class="icon anm anm-check-circle-o me-2 text-success"></i>
                                                <strong style="color: #2c3e50;">{{ sale.method_payment }}</strong>
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="block p-0">
                            <div class="block-content">
                                <div class="shipping-details mb-4 mb-sm-0">
                                    <h3 class="mb-3 d-flex align-items-center" style="color: #2c3e50; font-size: 1.2rem; font-weight: 600;">
                                        <div class="icon-container me-3" style="width: 32px; height: 32px; background: #6f42c1; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="icon anm anm-file-text-l" style="color: white; font-size: 0.9rem;"></i>
                                        </div>
                                        Detalles del pedido
                                    </h3>
                                    <ng-container *ngIf="this.sale">
                                        <div class="order-details p-3" style="background: #f8f9fa; border-radius: 12px; border-left: 4px solid #6f42c1;">
                                            <div class="mb-2 d-flex align-items-center">
                                                <i class="icon anm anm-hashtag me-2" style="color: #6f42c1;"></i>
                                                <div>
                                                    <small class="text-muted d-block" style="font-size: 0.75rem;">ID del pedido</small>
                                                    <strong style="font-family: 'Courier New', monospace;">#PF{{ sale.printfulOrderId }}</strong>
                                                </div>
                                            </div>
                                            <div class="mb-2 d-flex align-items-center">
                                                <i class="icon anm anm-calendar-l me-2" style="color: #6f42c1;"></i>
                                                <div>
                                                    <small class="text-muted d-block" style="font-size: 0.75rem;">Fecha del pedido</small>
                                                    <strong>{{ formatDate(sale.updatedAt) }}</strong>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <i class="icon anm anm-dollar me-2" style="color: #6f42c1;"></i>
                                                <div>
                                                    <small class="text-muted d-block" style="font-size: 0.75rem;">Total pagado</small>
                                                    <strong class="text-success" style="font-size: 1.1rem;">{{ (sale.total | number: '1.2-2') }}{{ euro }}</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="block p-0">
                            <div class="block-content">
                                <div class="billing-details">
                                    <h3 class="mb-3 d-flex align-items-center" style="color: #2c3e50; font-size: 1.2rem; font-weight: 600;">
                                        <div class="icon-container me-3" style="width: 32px; height: 32px; background: #fd7e14; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="icon anm anm-truck-l" style="color: white; font-size: 0.9rem;"></i>
                                        </div>
                                        Estado del env√≠o
                                    </h3>
                                    
                                    <!-- Estado visual del env√≠o -->
                                    <div class="shipping-status mb-3 p-3" style="background: #fff3cd; border-radius: 12px; border-left: 4px solid #fd7e14;">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="status-indicator me-3" style="width: 12px; height: 12px; background: #fd7e14; border-radius: 50%;"></div>
                                            <strong style="color: #856404;">üîÑ Procesando pedido</strong>
                                        </div>
                                        <small class="text-muted">Tu pedido est√° siendo preparado por nuestro proveedor Printful</small>
                                    </div>
                                    
                                    <!-- Fecha estimada -->
                                    <div class="delivery-estimate p-3" style="background: #f8f9fa; border-radius: 12px; border-left: 4px solid #fd7e14;">
                                        <div class="mb-2">
                                            <i class="icon anm anm-calendar-l me-2" style="color: #fd7e14;"></i>
                                            <small class="text-muted d-block" style="font-size: 0.75rem;">Fecha estimada de entrega</small>
                                        </div>
                                        <!-- Si hay fechas espec√≠ficas -->
                                        <div *ngIf="minDeliveryDate && maxDeliveryDate; else defaultDelivery">
                                            <strong class="text-primary" style="font-size: 1rem;">
                                                <span *ngIf="minDeliveryDate === maxDeliveryDate">
                                                    üìÖ {{ formatearFechaEntrega(minDeliveryDate).label }}
                                                </span>
                                                <span *ngIf="minDeliveryDate !== maxDeliveryDate">
                                                    üìÖ {{ formatearFechaEntrega(minDeliveryDate).label }} - {{ formatearFechaEntrega(maxDeliveryDate).label }}
                                                </span>
                                            </strong>
                                        </div>
                                        <!-- Fallback cuando no hay fechas espec√≠ficas -->
                                        <ng-template #defaultDelivery>
                                            <strong class="text-primary" style="font-size: 1rem;">
                                                üìÖ 3-7 d√≠as laborables
                                            </strong>
                                            <div class="mt-1">
                                                <small class="text-muted">Tiempo estimado seg√∫n tu ubicaci√≥n</small>
                                            </div>
                                        </ng-template>
                                    </div>
                                    
                                    <!-- Bot√≥n de seguimiento mejorado -->
                                    <div class="mt-3">
                                        <button class="btn-dark-ld" 
                                                style="border-radius: 8px; font-weight: 600;"
                                                (click)="navigateToTrackOrder()">
                                            <i class="icon anm anm-search-plus-l me-2"></i>
                                            Seguir mi pedido
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- DETAILS COMPRA -->

            <!-- ACCIONES FINALES -->
            <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                <!--Acciones del usuario-->
                <div class="final-actions mt-5 p-4" style="background: #ffffff; border-radius: 16px; border: 1px solid #e9ecef; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <h4 class="text-center mb-4" style="color: #2c3e50; font-weight: 600;">¬øQu√© te gustar√≠a hacer ahora?</h4>
                    
                    <div class="row g-3">

                        <!-- Seguir comprando -->
                        <div class="col-12 col-md-6">

                             <a [routerLink]="['/', country, locale, 'shop', 'filter-products']"  class="text-decoration-none d-block">
                                <button class="btn-dark-ld">
                                    <i class="me-3 icon anm anm-bag-l" style="font-size: 1.3rem;"></i>
                                    <span style="font-size: 1rem;">Seguir comprando</span>
                                </button>
                            </a>
                            
                        </div>
                        
                        <!-- Contactar soporte -->
                        <div class="col-12 col-md-6">
                            <a [href]="'mailto:soporte@lujandev.com?subject=Consulta sobre pedido ' + (sale?.printfulOrderId ? '#PF' + sale.printfulOrderId : sale?.n_transaction) + '&body=Hola, tengo una consulta sobre mi pedido.'" class="text-decoration-none d-block">
                                <button class="btn-dark-ld">
                                    <i class="me-3 icon anm anm-envelope-l" style="font-size: 1.3rem;"></i>
                                    <span style="font-size: 1rem;">¬øNecesitas ayuda?</span>
                                </button>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Mensaje adicional -->
                    <div class="text-center mt-4">
                        <div class="alert alert-light border-0" style="background: #f0f8f0; border-radius: 12px;">
                            <i class="icon anm anm-heart text-danger me-2"></i>
                            <strong>¬°Gracias por confiar en nosotros!</strong> 
                            <br>
                            <small class="text-muted">Recibir√°s actualizaciones del estado de tu pedido por email y podr√°s seguir el env√≠o en tiempo real.</small>
                        </div>
                    </div>
                </div>
                <!--Fin acciones del usuario-->
            </div>
            <!-- END BOTON SEGUIR COMPRANDO -->
        </div>
    </ng-container>
</div>
