<!--Page Wrapper-->
<div class="page-wrapper">

    <!-- Loading -->
    <div *ngIf="loading" class="loading-spinner border d-flex vh-100 justify-content-center align-items-center">
        <div class="row">
            <div class="col-sm-2">
                <div class="sp sp-bars"></div>
            </div>
        </div>
    </div>
    <!-- End Loading -->

    <!-- Body Container -->
    <div id="page-content">

        <!--Page Header-->
        <div class="page-header text-center bg-transparent mb-0 p-3">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12 col-sm-12 col-md-12 col-lg-12 d-flex justify-content-between align-items-start">
                        <div class="page-title ">
                            <h2 class="fw-bold text-uppercase">Mis compras</h2>
                        </div>
                        <!--Breadcrumbs-->
                        <div class="breadcrumbs d-none"><a href="index.html" onclick="return false;" routerLink="/" title="Back to the home page">Lujandev.com</a><span class="main-title"><i class="icon anm anm-angle-right-l"></i>Mis compras</span></div>
                        <!--End Breadcrumbs-->
                    </div>
                </div>
            </div>
        </div>
        <!--End Page Header-->

        <!--Main Content-->
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                    <div class="dashboard-content h-100">
                        <!-- My Orders -->
                        <div class="tab-pane h-100" id="orders">
                            <div class="orders-card mt-0 h-100">
                                <ng-container *ngIf="sale_details.length == 0; else allShowOrders">
                                    <div class="d-flex justify-content-center align-items-center">
                                        <div class="p-2 text-center">
                                            <div class="inner mb-3 d-none">
                                                <div class="bradcrumb-thumb">
                                                    <img src="assets/images/favicon.png" alt="Image" style="width: 50px; height: 50px;">
                                                </div>
                                            </div>
                                            <!-- <h5 class="header-title mb-0 fw-bold h3 mb-4">Mis compras</h5> -->
                                            <strong class="h3 text-uppercase">A√∫n no tienes ninguna compra</strong>
                                            <p class="pt-3">Cuando compres algo online, aparecer√° aqu√≠.</p>
                                            <p class="pt-3 d-none">Pide tu ticket digital la pr√≥xima vez que compres en tienda para <br /> llevarlo siempre contigo.</p>
                                        </div>
                                    </div>
                                    <div class="view-collection text-center mt-4 mb-5 mt-md-5">
                                        <a class="btn-dark-ld text-uppercase" href="#" onclick="return false;" [routerLink]="['/', locale, country, 'shop', 'filter-products']">Descubrir lo √∫ltimo</a>
                                    </div>
                                    <!-- <hr> -->
                                </ng-container>
                                <ng-template #allShowOrders>
                                    <div class="row">
                                        <!-- Left: Orders list (main column) -->
                                        <div class="col-12 col-lg-8 main-col">
                                            <div class="d-flex flex-column gap-3">
                                                <ng-container *ngIf="paginatedSaleDetails && paginatedSaleDetails.length > 0">
                                                    <!-- Iterate paginatedSaleDetails and render one order-card per sale group -->
                                                    <ng-container *ngFor="let detail of paginatedSaleDetails; let i = index">
                                                        <ng-container *ngIf="i === 0 || (paginatedSaleDetails[i - 1].sale?.id !== detail.sale?.id)">
                                                            <div class="order-card p-3 border rounded bg-white">
                                                                <div class="d-flex justify-content-between align-items-start mb-3 order-header">
                                                                    <div>
                                                                        <strong class="d-block">Pedido #{{ detail.sale?.id || detail.sale_id || ('#' + (i + 1)) }}</strong>
                                                                        <small class="text-muted">Fecha: {{ (detail.sale?.updatedAt || detail.sale?.createdAt || detail.createdAt) | date:'mediumDate' }}</small>
                                                                    </div>
                                                                    <div class="text-end">
                                                                        <span class="badge bg-dark mb-1">{{ detail.sale?.status || detail.status || 'Processing' }}</span>
                                                                        <div class="small">Total: <strong>{{ euro }}{{ getSaleTotalPrice(detail.sale) }}</strong></div>
                                                                    </div>
                                                                </div>

                                                                <!-- Products for this order (only those details that belong to the same sale) -->
                                                                <div class="d-flex flex-column gap-2 order-products">
                                                                    <ng-container *ngFor="let prodDetail of (paginatedSaleDetails | slice:i)">
                                                                        <ng-container *ngIf="(prodDetail.sale?.id || prodDetail.sale_id) === (detail.sale?.id || detail.sale_id)">
                                                                            <div class="d-flex flex-lg-row align-items-center p-2 bg-transparent rounded" role="article">
                                                                                <div class="me-3">
                                                                                    <a href="#" onclick="return false;" [routerLink]="['/', locale, country, 'shop', 'product', prodDetail.product?.slug || prodDetail.product.slug]">
                                                                                        <img class="rounded-0 blur-up lazyload" [attr.data-src]="prodDetail.product?.imagen || prodDetail.product.imagen" [src]="prodDetail.product?.imagen || prodDetail.product.imagen" alt="product" width="80" height="80" style="object-fit:cover;border-radius:6px;" />
                                                                                    </a>
                                                                                </div>
                                                                                <div class="flex-fill">
                                                                                    <div class="text-uppercase lh-1">
                                                                                        <a href="#" onclick="return false;" [routerLink]="['/', locale, country, 'shop', 'product', prodDetail.product?.slug || prodDetail.product.slug]">{{ prodDetail.product?.title || prodDetail.product.title }}</a>
                                                                                    </div>
                                                                                    <div class="d-flex align-items-center mt-1">
                                                                                        <div class="me-3 small text-muted">Art. n¬∫ {{ prodDetail.product?.sku || prodDetail.product.sku || '‚Äî' }}</div>
                                                                                        <div class="me-3 small text-muted">Cant: {{ prodDetail.cantidad || prodDetail.quantity || prodDetail.qty || 1 }}</div>
                                                                                        <div class="me-3 small text-muted">Estado: <span class="badge rounded-pill bg-secondary">{{ prodDetail.status || prodDetail.state || '‚Äî' }}</span></div>
                                                                                    </div>
                                                                                    
                                                                                    <!-- üè∑Ô∏è Informaci√≥n de descuentos -->
                                                                                    <div *ngIf="hasDiscount(prodDetail)" class="mt-2 p-2 bg-light rounded">
                                                                                        <div class="row g-2 small">
                                                                                            <div class="col-12">
                                                                                                <span class="badge bg-success me-2">{{ getDiscountType(prodDetail) }}</span>
                                                                                                <span class="text-success fw-bold">{{ getDiscountPercentage(prodDetail) }}% de descuento</span>
                                                                                            </div>
                                                                                            <div class="col-6">
                                                                                                <div class="text-muted">Precio original:</div>
                                                                                                <div class="text-decoration-line-through">{{ euro }}{{ getOriginalPriceForDisplay(prodDetail) }}</div>
                                                                                            </div>
                                                                                            <div class="col-6">
                                                                                                <div class="text-muted">Ahorro:</div>
                                                                                                <div class="text-success fw-bold">-{{ euro }}{{ getDiscountAmount(prodDetail) }}</div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="text-end ms-3">
                                                                                    <div class="small text-muted">{{ hasDiscount(prodDetail) ? 'Precio final' : 'Precio' }}</div>
                                                                                    <div class="fw-bold {{ hasDiscount(prodDetail) ? 'text-success' : '' }}">{{ euro }}{{ getDisplayPrice(prodDetail) }}</div>
                                                                                    <div *ngIf="hasDiscount(prodDetail)" class="small text-muted">
                                                                                        por {{ prodDetail.cantidad || prodDetail.quantity || prodDetail.qty || 1 }} ud.
                                                                                    </div>
                                                                                    <div class="mt-1">
                                                                                        <a [routerLink]="['/', locale, country, 'shop', 'product', prodDetail.product?.slug || prodDetail.product.slug]" class="view"><i class="icon anm anm-eye btn-link fs-6"></i></a>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </ng-container>
                                                                    </ng-container>
                                                                </div>
                                                                
                                                                <!-- Bot√≥n para descargar recibo -->
                                                                <div class="d-flex justify-content-end mt-3 pt-2 border-top">
                                                                    <button 
                                                                        type="button" 
                                                                        class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1" 
                                                                        (click)="downloadReceipt(detail.sale?.id || detail.sale_id)"
                                                                        [disabled]="isDownloadingReceipt(detail.sale?.id || detail.sale_id)"
                                                                        title="Descargar recibo en PDF">
                                                                        <!-- Spinner cuando est√° descargando -->
                                                                        <ng-container *ngIf="isDownloadingReceipt(detail.sale?.id || detail.sale_id)">
                                                                            <div class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></div>
                                                                            <small>Generando...</small>
                                                                        </ng-container>
                                                                        <!-- Estado normal -->
                                                                        <ng-container *ngIf="!isDownloadingReceipt(detail.sale?.id || detail.sale_id)">
                                                                            <i class="icon anm anm-download-l"></i>
                                                                            <small>Descargar recibo</small>
                                                                        </ng-container>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </ng-container>
                                                    </ng-container>
                                                </ng-container>
                                            </div>
                                        </div>

                                        <!-- Right: Sidebar (help / quick actions) -->
                                        <div class="col-12 col-lg-4 mt-4 mt-lg-0">
                                            <div class="cart-info sidebar-sticky bg-transparent border-0 p-3 rounded bg-white">
                                                <h3 class="title mb-3 ls-2 text-uppercase">Resumen</h3>
                                                <div class="cart-order-detail cart-col small text-muted">
                                                    <div class="row g-0 mb-2">
                                                        <span class="col-6 fw-light">Pedidos</span>
                                                        <span class="col-6 text-end">{{ sale_orders?.length || 0 }}</span>
                                                    </div>
                                                    <div class="row g-0 mb-2">
                                                        <span class="col-6 fw-light">√öltima compra</span>
                                                        <span class="col-6 text-end small text-muted">{{ lastPurchaseDate | date:'mediumDate' }}</span>
                                                    </div>
                                                    <div class="row g-0 mb-2">
                                                        <span class="col-6 fw-light">Ayuda</span>
                                                        <span class="col-6 text-end"><a href="#" onclick="return false;" class="text-decoration-underline">Atenci√≥n al cliente</a></span>
                                                    </div>
                                                    <div class="mt-3">
                                                        <a [routerLink]="['/', locale, country, 'shop', 'filter-products']" class="btn-dark-ld text-uppercase d-block text-center">Descubrir lo √∫ltimo</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </ng-template>
                            </div>
                        </div>
                        <!-- End My Orders -->
                    </div>
                </div>
            </div>
            <!-- Pagination -->
            <!-- <nav class="clearfix pagination-bottom">
                <ul class="pagination justify-content-center">
                    <li class="page-item disabled"><a class="page-link" href="#"><i class="icon anm anm-angle-left-l"></i></a></li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link dot" href="#">...</a></li>
                    <li class="page-item"><a class="page-link" href="#">5</a></li>
                    <li class="page-item"><a class="page-link" href="#"><i class="icon anm anm-angle-right-l"></i></a></li>
                </ul>
            </nav> -->

            <!-- Paginaci√≥n -->
            <!-- Paginaci√≥n -->
            <nav class="clearfix pagination-bottom" *ngIf="sale_orders.length > 0">
                <ul class="pagination justify-content-center">
                    <li class="page-item" [class.disabled]="currentPage === 1">
                        <a class="page-link" href="#" onclick="return false;" (click)="onPageChange(currentPage - 1)" [class.disabled]="currentPage === 1">
                            <i class="icon anm anm-angle-left-l"></i>
                        </a>
                    </li>
                    <!-- Generar p√°ginas din√°micamente -->
                    <li *ngFor="let page of [].constructor(totalPages); let i = index" class="page-item" [class.active]="i + 1 === currentPage">
                        <a class="page-link" href="#" onclick="return false;" (click)="onPageChange(i + 1)">
                            {{ i + 1 }}
                        </a>
                    </li>
                    <li class="page-item" [class.disabled]="currentPage === totalPages">
                        <a class="page-link" href="#" onclick="return false;" (click)="onPageChange(currentPage + 1)" [class.disabled]="currentPage === totalPages">
                            <i class="icon anm anm-angle-right-l"></i>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- End Pagination -->
        </div>

    </div>
</div>