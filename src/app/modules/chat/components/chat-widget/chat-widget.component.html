<div class="chat-widget-container" *ngIf="isChatEnabled">
  <!-- Floating toggle (keeps original bindings/directives) -->
  <div class="chat-button" [class.has-unread]="unreadCount > 0" (click)="openChat()" *ngIf="!isChatOpen" role="button" aria-label="Lujandev Assistant">
    <span class="chat-button__icon chat-icon" aria-hidden="true">
      <!-- <i class="icon anm anm-chat"></i> -->
       <svg width="65" height="65" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" data-spec="button-icon" __source="[object Object]">
<path fill-rule="evenodd" clip-rule="evenodd" d="M4 9.78374C4 5.84433 4.81543 5 8.62 5H11.38C15.1846 5 16 5.84433 16 9.78374C16 13.7232 15.1846 14.9008 11.38 14.9008H10.8303C10.8025 14.9346 10.7703 14.9666 10.7336 14.9962L8.54286 16.86C8.12929 17.1935 7.5137 16.898 7.5137 16.3667V14.87C4.65254 14.6884 4 13.3078 4 9.78374ZM10 10.6667C10.3682 10.6667 10.6667 10.3682 10.6667 10C10.6667 9.63181 10.3682 9.33333 10 9.33333C9.63181 9.33333 9.33333 9.63181 9.33333 10C9.33333 10.3682 9.63181 10.6667 10 10.6667ZM13.3333 10C13.3333 10.3682 13.0349 10.6667 12.6667 10.6667C12.2985 10.6667 12 10.3682 12 10C12 9.63181 12.2985 9.33333 12.6667 9.33333C13.0349 9.33333 13.3333 9.63181 13.3333 10ZM7.33333 10.6667C7.70152 10.6667 8 10.3682 8 10C8 9.63181 7.70152 9.33333 7.33333 9.33333C6.96514 9.33333 6.66667 9.63181 6.66667 10C6.66667 10.3682 6.96514 10.6667 7.33333 10.6667Z" fill="white"></path>
</svg>
    </span>
    <span class="unread-badge" *ngIf="unreadCount > 0" aria-live="polite">{{unreadCount}}</span>
  </div>

  <!-- Chat panel -->
  <div class="chat-window" data-chat-widget [class.open]="isChatOpen" [attr.aria-hidden]="!isChatOpen">
    <!-- Header -->
    <header class="chat-header">
      <h3 class="chat-header__title text-white text-uppercase">Lujandev Assistant</h3>
      <div class="chat-actions">
        <button class="minimize-btn" (click)="closeChat()" aria-label="Minimizar chat">
          <i class="icon anm anm-minus-l" aria-hidden="true"></i>
        </button>
        <!-- full close button for mobile/fullscreen behaviour: show confirmation popup instead of closing directly -->
        <button class="close-btn" (click)="showCloseConfirm = true" aria-label="Cerrar chat">
          <i class="icon anm anm-times-l" aria-hidden="true"></i>
        </button>
      </div>
    </header>

    <!-- Main content: messages -->
    <main class="chat-body" #messagesContainer role="region" aria-live="polite">
      <!-- Welcome placeholder when empty -->
      <div class="welcome-message" *ngIf="messages.length === 0">
        <div class="welcome-content">
          <i class="icon anm anm-comments-l mb-2" style="font-size: 2.5rem; color: #222;"></i>
          <p class="mb-0" style="font-size: 0.95rem; color: #6c757d; line-height: 1.5;">¡Hola! ¿En qué podemos ayudarte hoy?</p>
        </div>
      </div>

      <!-- Messages list (semantic list for accessibility) -->
      <ul class="messages-list" data-chat-messages role="list">
        <li class="message-item"
            *ngFor="let message of messages"
            [class.user-message]="isSentByMe(message)"
            [class.agent-message]="!isSentByMe(message) && !isSystemMessage(message)"
            [class.system-message]="isSystemMessage(message)"
            role="listitem">
          <div class="message-bubble">
            <p class="message-text">{{message.message}}</p>
            <span class="message-time" aria-hidden="true">{{message.timestamp}}</span>
          </div>
        </li>
      </ul>

      <!-- Typing indicator -->
      <div class="typing-indicator" *ngIf="typingStatus.isTyping" role="status" aria-live="polite">
        <div class="typing-bubble">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
        <p class="typing-text">{{typingStatus.name}} está escribiendo...</p>
      </div>
    </main>

    <!-- Footer / input -->
    <footer class="chat-footer">
      <form (ngSubmit)="sendMessage()">
        <div class="message-input-container">
          <div class="input-wrapper">
            <textarea
              [formControl]="messageControl"
              placeholder="Escribe tu mensaje..."
              (keydown)="handleEnter($event)"
              aria-label="Escribe un mensaje"
              data-chat-input
              rows="1"
            ></textarea>

            <!-- send button placed inside input wrapper; keep bindings intact -->
            <button type="submit" class="send-btn" data-send-btn [disabled]="messageControl.invalid" aria-label="Enviar mensaje">
              <!-- inline svg icon preserved -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" style="fill: currentcolor;" aria-hidden="true" class="Icon_icon-content-brand__AKwiy"><path d="m5.4 10.1-.7-.7L12 2l7.4 7.4-.7.7L12.6 4v18h-1V3.9z"></path></svg>
            </button>
          </div>

          <div class="privacy-notice">
            <small class="text-muted">Al continuar, confirmas que has leído la <a class="text-link" href="#" onclick="return false;" data-testid="mng-link">Política de privacidad</a></small>
          </div>
        </div>
      </form>
    </footer>
    <!-- Confirmación de cierre (aparece flotando en la parte inferior del panel) -->
    <div class="close-confirm" *ngIf="showCloseConfirm" role="dialog" aria-modal="true" aria-label="Confirmación de abandono">
      <div class="close-confirm__content">
        <h4 class="close-confirm__title">¿Quieres abandonar el chat?</h4>
        <p class="close-confirm__text">Al abandonar, perderás la conversación y tendrás que empezar de nuevo.</p>
        <div class="close-confirm__actions">
          <button type="button" class="btn btn-abandon" (click)="confirmAbandon()">Abandonar</button>
          <button type="button" class="btn btn-cancel" (click)="showCloseConfirm = false">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- overlay shown on mobile when window is open (controlled via CSS) -->
  <div class="chat-overlay" aria-hidden="true"></div>
</div>