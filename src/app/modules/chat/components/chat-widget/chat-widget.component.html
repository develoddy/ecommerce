<div class="chat-widget-container">
  <!-- Floating toggle (keeps original bindings/directives) -->
  <div class="chat-button" [class.has-unread]="unreadCount > 0" (click)="openChat()" *ngIf="!isChatOpen" role="button" aria-label="Lujandev Assistant">
    <span class="chat-button__icon chat-icon" aria-hidden="true">
      <i class="icon anm anm-chat"></i>
    </span>
    <span class="unread-badge" *ngIf="unreadCount > 0" aria-live="polite">{{unreadCount}}</span>
  </div>

  <!-- Chat panel -->
  <div class="chat-window" data-chat-widget [class.open]="isChatOpen" [attr.aria-hidden]="!isChatOpen">
    <!-- Header -->
    <header class="chat-header">
      <h3 class="chat-header__title text-white text-uppercase">Lujandev Assistant</h3>
      <div class="chat-actions">
        <button class="minimize-btn" (click)="closeChat()" aria-label="Minimizar chat">
          <i class="icon anm anm-minus-l" aria-hidden="true"></i>
        </button>
        <!-- full close button for mobile/fullscreen behaviour: show confirmation popup instead of closing directly -->
        <button class="close-btn" (click)="showCloseConfirm = true" aria-label="Cerrar chat">
          <i class="icon anm anm-times-l" aria-hidden="true"></i>
        </button>
      </div>
    </header>

    <!-- Main content: messages -->
    <main class="chat-body" #messagesContainer role="region" aria-live="polite">
      <!-- Welcome placeholder when empty -->
      <div class="welcome-message" *ngIf="messages.length === 0">
        <div class="welcome-content">
          <i class="icon anm anm-comments-l mb-2" style="font-size: 2.5rem; color: #222;"></i>
          <p class="mb-0" style="font-size: 0.95rem; color: #6c757d; line-height: 1.5;">¡Hola! ¿En qué podemos ayudarte hoy?</p>
        </div>
      </div>

      <!-- Messages list (semantic list for accessibility) -->
      <ul class="messages-list" data-chat-messages role="list">
        <li class="message-item"
            *ngFor="let message of messages"
            [class.user-message]="isSentByMe(message)"
            [class.agent-message]="!isSentByMe(message) && !isSystemMessage(message)"
            [class.system-message]="isSystemMessage(message)"
            role="listitem">
          <div class="message-bubble">
            <p class="message-text">{{message.message}}</p>
            <span class="message-time" aria-hidden="true">{{message.timestamp}}</span>
          </div>
        </li>
      </ul>

      <!-- Typing indicator -->
      <div class="typing-indicator" *ngIf="typingStatus.isTyping" role="status" aria-live="polite">
        <div class="typing-bubble">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
        <p class="typing-text">{{typingStatus.name}} está escribiendo...</p>
      </div>
    </main>

    <!-- Footer / input -->
    <footer class="chat-footer">
      <form (ngSubmit)="sendMessage()">
        <div class="message-input-container">
          <div class="input-wrapper">
            <textarea
              [formControl]="messageControl"
              placeholder="Escribe tu mensaje..."
              (keydown)="handleEnter($event)"
              aria-label="Escribe un mensaje"
              data-chat-input
              rows="1"
            ></textarea>

            <!-- send button placed inside input wrapper; keep bindings intact -->
            <button type="submit" class="send-btn" data-send-btn [disabled]="messageControl.invalid" aria-label="Enviar mensaje">
              <!-- inline svg icon preserved -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" style="fill: currentcolor;" aria-hidden="true" class="Icon_icon-content-brand__AKwiy"><path d="m5.4 10.1-.7-.7L12 2l7.4 7.4-.7.7L12.6 4v18h-1V3.9z"></path></svg>
            </button>
          </div>

          <div class="privacy-notice">
            <small class="text-muted">Al continuar, confirmas que has leído la <a class="text-link" href="#" onclick="return false;" data-testid="mng-link">Política de privacidad</a></small>
          </div>
        </div>
      </form>
    </footer>
    <!-- Confirmación de cierre (aparece flotando en la parte inferior del panel) -->
    <div class="close-confirm" *ngIf="showCloseConfirm" role="dialog" aria-modal="true" aria-label="Confirmación de abandono">
      <div class="close-confirm__content">
        <h4 class="close-confirm__title">¿Quieres abandonar el chat?</h4>
        <p class="close-confirm__text">Al abandonar, perderás la conversación y tendrás que empezar de nuevo.</p>
        <div class="close-confirm__actions">
          <button type="button" class="btn btn-abandon" (click)="confirmAbandon()">Abandonar</button>
          <button type="button" class="btn btn-cancel" (click)="showCloseConfirm = false">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- overlay shown on mobile when window is open (controlled via CSS) -->
  <div class="chat-overlay" aria-hidden="true"></div>
</div>